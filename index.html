<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nick Drum Beat Maker (Mix, Original Timing)</title>
<style>
  :root { --bg:#0b0c10; --card:#111217; --muted:#9aa0a6; --accent:#22c55e; --danger:#ef4444; --border:#20232b; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:32px; line-height:1.1; margin:0; letter-spacing:0.3px;
     background: linear-gradient(90deg,#fff,#22c55e 60%,#a7f3d0);
     -webkit-background-clip:text; background-clip:text; color:transparent;}
  .muted{color:var(--muted);font-size:12px}
  .btn{padding:10px 16px;border-radius:14px;border:1px solid var(--border);background:var(--accent);color:#051b0d;font-weight:700;cursor:pointer}
  .btn.stop{background:var(--danger);color:#fff}
  .btn.clear{background:#1f2937;color:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .tile{background:#0f1117;border:1px solid var(--border);border-radius:14px;padding:10px;cursor:pointer;transition:transform .08s ease}
  .tile:hover{transform:translateY(-2px)}
  .tile .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tile .id{font-weight:800;font-size:14px}
  .tile .name{font-size:12px;color:var(--muted)}
  .tile img{width:100%;height:120px;display:block;object-fit:contain;border-radius:10px;background:#fff;border:1px solid #2b2f3a}
  .selection{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .slot{min-height:140px;border:1px dashed var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;padding:6px;background:#0f1117}
  .slot.filled{border-style:solid}
  .slot img{width:100%;height:120px;object-fit:contain;border-radius:8px;background:#fff;border:1px solid #2b2f3a}
  input[type=range]{accent-color:var(--accent)}
  .value{width:56px;text-align:right;font-feature-settings:'tnum';font-variant-numeric:tabular-nums}
  .warn{color:#fbbf24;font-size:12px;margin-left:6px}
  .note{font-size:12px;color:var(--muted);margin-top:8px}

  .tabs{display:flex;gap:12px;margin-top:12px}
  .tab{flex:1;padding:12px;border-radius:12px;background:#1f2937;color:#e5e7eb;cursor:pointer;text-align:center;border:1px solid var(--border)}
  .tab.active{background:#0f172a; box-shadow: 0 0 0 2px #334155 inset}

  /* continuous highlight */
  .slot.playing{
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 2px var(--accent) inset, 0 0 16px rgba(34,197,94,0.55);
    transition: box-shadow .08s ease, border-color .08s ease;
  }
</style>
</head>
<body>
<div class="container">
  <div style="text-align:center; margin-bottom: 12px;">
    <h1>Nick Drum Beat Maker</h1>
    <div class="muted">Pick 1–4 tiles (duplicates allowed). Start to loop only the selected tiles. Clear to reset selection. BPM 60–200.</div>
  </div>

  <div class="row">
    <button id="startBtn" class="btn">Start</button>
    <button id="stopBtn" class="btn stop">Stop</button>
    <button id="clearBtn" class="btn clear">Clear Selection</button>
    <div class="row">
      <label for="bpm" class="muted">BPM</label>
      <input id="bpm" type="range" min="60" max="200" value="100" />
      <div id="bpmVal" class="value muted">100</div>
      <div class="row" style="gap:6px;margin-left:10px">
        <button type="button" class="btn clear" data-step="-5">-5</button>
        <button type="button" class="btn clear" data-step="-1">-1</button>
        <button type="button" class="btn clear" data-step="1">+1</button>
        <button type="button" class="btn clear" data-step="5">+5</button>
      </div>
    </div>
    <div id="status" class="warn"></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="selection" id="selection">
      <div class="slot" id="slot0"><span class="muted">Slot 1</span></div>
      <div class="slot" id="slot1"><span class="muted">Slot 2</span></div>
      <div class="slot" id="slot2"><span class="muted">Slot 3</span></div>
      <div class="slot" id="slot3"><span class="muted">Slot 4</span></div>
    </div>
    <div class="note" id="note"></div>
  </div>

  <div class="tabs">
    <div class="tab active" data-mode="4">4 Beat</div>
    <div class="tab" data-mode="8">8 Beat</div>
    <div class="tab" data-mode="16">16 Beat</div>
  </div>

  <h2 style="margin-top:18px; font-size:18px;">Tiles</h2>
  <div class="grid cols-3" id="library"></div>
</div>

<script>
// ==== Original pattern sets (as in original single files) ====
const P4 = [
  { id:1, name:"Pattern 1", img:"Images/4beat/1.png", hh:[0,2], sd:[2], bd:[] },
  { id:2, name:"Pattern 2", img:"Images/4beat/2.png", hh:[0,2], sd:[2], bd:[0] },
  { id:3, name:"Pattern 3", img:"Images/4beat/3.png", hh:[0,2], sd:[2], bd:[1] },
  { id:4, name:"Pattern 4", img:"Images/4beat/4.png", hh:[0,2], sd:[2], bd:[2] },
  { id:5, name:"Pattern 5", img:"Images/4beat/5.png", hh:[0,2], sd:[2], bd:[3] },
  { id:6, name:"Pattern 6", img:"Images/4beat/6.png", hh:[0,2], sd:[2], bd:[0, 1] },
  { id:7, name:"Pattern 7", img:"Images/4beat/7.png", hh:[0,2], sd:[2], bd:[0, 3] },
  { id:8, name:"Pattern 8", img:"Images/4beat/8.png", hh:[0,2], sd:[2], bd:[0, 2] },
  { id:9, name:"Pattern 9", img:"Images/4beat/9.png", hh:[0,2], sd:[2], bd:[1, 3] }
];
const P8 = [
  { id:1, name:"Pattern 1", img:'Images/8beat/1.png', hh:[0,1,2,3], sd:[2], bd:[] },
  { id:2, name:"Pattern 2", img:'Images/8beat/2.png', hh:[0,1,2,3], sd:[2], bd:[0] },
  { id:3, name:"Pattern 3", img:'Images/8beat/3.png', hh:[0,1,2,3], sd:[2], bd:[1] },
  { id:4, name:"Pattern 4", img:'Images/8beat/4.png', hh:[0,1,2,3], sd:[2], bd:[2] },
  { id:5, name:"Pattern 5", img:'Images/8beat/5.png', hh:[0,1,2,3], sd:[2], bd:[3] },
  { id:6, name:"Pattern 6", img:'Images/8beat/6.png', hh:[0,1,2,3], sd:[2], bd:[0, 1] },
  { id:7, name:"Pattern 7", img:'Images/8beat/7.png', hh:[0,1,2,3], sd:[2], bd:[0, 3] },
  { id:8, name:"Pattern 8", img:'Images/8beat/8.png', hh:[0,1,2,3], sd:[2], bd:[0, 2] },
  { id:9, name:"Pattern 9", img:'Images/8beat/9.png', hh:[0,1,2,3], sd:[2], bd:[1, 3] }
];
const P16 = [
  { id:1, name:'Pattern 1', img:'Images/16beat/1.png', hh:[0,1,2,3,4,5,6,7], bd:[], sd:[4] },
  { id:2, name:'Pattern 2', img:'Images/16beat/2.png', hh:[0,1,2,3,4,5,6,7], bd:[0], sd:[4] },
  { id:3, name:'Pattern 3', img:'Images/16beat/3.png', hh:[0,1,2,3,4,5,6,7], bd:[2], sd:[4] },
  { id:4, name:'Pattern 4', img:'Images/16beat/4.png', hh:[0,1,2,3,4,5,6,7], bd:[4], sd:[4] },
  { id:5, name:'Pattern 5', img:'Images/16beat/5.png', hh:[0,1,2,3,4,5,6,7], bd:[6], sd:[4] },
  { id:6, name:'Pattern 6', img:'Images/16beat/6.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 2], sd:[4] },
  { id:7, name:'Pattern 7', img:'Images/16beat/7.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 6], sd:[4] },
  { id:8, name:'Pattern 8', img:'Images/16beat/8.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 4], sd:[4] },
  { id:9, name:'Pattern 9', img:'Images/16beat/9.png', hh:[0,1,2,3,4,5,6,7], bd:[2, 6], sd:[4] }
];

const MODES = {
  "4":  { title:"4 Beat",  patterns:P4,  tileSteps:4,  stepType:"eighth",    note:"Each tile is 1 beat (4 sixteenth notes). 4 tiles = 1 bar." },
  "8":  { title:"8 Beat",  patterns:P8,  tileSteps:4,  stepType:"eighth",    note:"Each tile is 2 beats (4 eighth notes). 4 tiles = 2 bars." },
  "16": { title:"16 Beat", patterns:P16, tileSteps:8,  stepType:"sixteenth", note:"Each tile is 2 beats (8 sixteenth notes). 4 tiles = 2 bars (4/4)." }
};

// === Helpers to normalize to 16th-note base for mixing ===
function toSixteenthPattern(p, stepType, tileSteps){
  const mul = (stepType==='eighth') ? 2 : 1; // eighth -> x2 to sixteenth
  const map = arr => (arr||[]).map(v => v*mul);
  return {
    id:p.id, name:p.name, img:p.img,
    hh:map(p.hh), sd:map(p.sd), bd:map(p.bd),
    TILE_STEPS: tileSteps * mul
  };
}
function currentPatternObjectById(id){
  const conf = MODES[MODE];
  const src = conf.patterns.find(x=>x.id===id);
  if(!src) return null;
  return toSixteenthPattern(src, conf.stepType, conf.tileSteps);
}

// === State ===
let MODE="4";
let CONF=MODES[MODE];
let PATTERNS=CONF.patterns.slice();
let selectedObjs=[null,null,null,null]; // up to 4 mixed tiles
let isPlaying=false, nextNoteTime=0, currentStep=0, timer=null;

const libEl=document.getElementById('library');
const noteEl=document.getElementById('note');
const slots=[document.getElementById('slot0'),document.getElementById('slot1'),document.getElementById('slot2'),document.getElementById('slot3')];
const statusEl=document.getElementById('status');
const bpm=document.getElementById('bpm'), bpmVal=document.getElementById('bpmVal');

// === Audio ===
let audioCtx, masterGain, reverb;
function ensureCtx(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(audioCtx.destination);
    reverb = audioCtx.createConvolver(); reverb.buffer = createReverbIR(audioCtx, 1.5, 2.5); reverb.connect(masterGain);
  }
  return audioCtx;
}
function createReverbIR(ctx, seconds=1.5, decay=2.5){
  const rate=ctx.sampleRate, length=Math.floor(rate*seconds);
  const buf=ctx.createBuffer(2,length,rate);
  for(let ch=0;ch<2;ch++){
    const d=buf.getChannelData(ch);
    for(let i=0;i<length;i++){ const t=i/length; d[i]=(Math.random()*2-1)*Math.pow(1-t,decay); }
  }
  return buf;
}
function playKick(time){
  const ctx=ensureCtx();
  const osc=ctx.createOscillator(); osc.type='sine';
  osc.frequency.setValueAtTime(150,time); osc.frequency.exponentialRampToValueAtTime(50,time+0.12);
  const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.14);
  osc.connect(g); g.connect(masterGain); g.connect(reverb);
  osc.start(time); osc.stop(time+0.16);
}
function playSnare(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.25, ctx.sampleRate);
  const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb;
  const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.7;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=900;
  const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.18);
  src.connect(bp).connect(hp).connect(g); g.connect(masterGain); g.connect(reverb);
  src.start(time); src.stop(time+0.22);
}
function playHat(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.08, ctx.sampleRate);
  const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=8000;
  const g=ctx.createGain(); g.gain.setValueAtTime(0.6,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  src.connect(hp).connect(g); g.connect(masterGain); g.connect(reverb);
  src.start(time); src.stop(time+0.08);
}

// === Timing (base = sixteenth for mixing) ===
function stepDurationSec(){
  const v=parseInt(bpm.value,10);
  return 60/(v*4); // sixteenth
}

function buildCombined(){
  const chosen = selectedObjs.filter(o=>o);
  if(chosen.length===0) return null;
  const total = chosen.reduce((acc,o)=>acc+o.TILE_STEPS, 0);
  const out = { total, hh:Array(total).fill(0), sd:Array(total).fill(0), bd:Array(total).fill(0), tileBounds:[] };
  let base=0;
  chosen.forEach(o=>{
    o.hh.forEach(ix=>{ if(base+ix<total) out.hh[base+ix]=1; });
    o.sd.forEach(ix=>{ if(base+ix<total) out.sd[base+ix]=1; });
    o.bd.forEach(ix=>{ if(base+ix<total) out.bd[base+ix]=1; });
    base += o.TILE_STEPS;
    out.tileBounds.push(base);
  });
  return out;
}

function updateSlotHighlight(activeIdx){
  for(let i=0;i<4;i++){
    const el=slots[i]; if(!el) continue;
    if(i===activeIdx) el.classList.add('playing'); else el.classList.remove('playing');
  }
}
function clearSlotHighlight(){ slots.forEach(el=>el.classList.remove('playing')); }

function schedule(){
  const ctx=ensureCtx(); const P=buildCombined(); if(!P) return;
  const stepDur=stepDurationSec(); const total = P.total;
  while(nextNoteTime < ctx.currentTime + 0.12){
    const step = currentStep % total;
    // tile index by cumulative bounds
    let tileIdx = 0; while(tileIdx < P.tileBounds.length && step >= P.tileBounds[tileIdx]) tileIdx++;
    updateSlotHighlight(tileIdx);
    const t=nextNoteTime;
    if(P.hh[step]) playHat(t);
    if(P.sd[step]) playSnare(t);
    if(P.bd[step]) playKick(t);
    nextNoteTime += stepDur; currentStep = (currentStep + 1) % total;
  }
}

function start(){
  if(selectedObjs.every(o=>!o)){ statusEl.textContent='Pick at least 1 tile.'; return; }
  ensureCtx().resume(); isPlaying=true; currentStep=0; nextNoteTime=ensureCtx().currentTime+0.05;
  timer=setInterval(schedule,25); statusEl.textContent='';
}
function stop(){
  if(timer) clearInterval(timer); timer=null; isPlaying=false; clearSlotHighlight();
}

// === UI ===
function renderLibrary(){
  libEl.innerHTML='';
  PATTERNS.forEach(p=>{
    const card=document.createElement('div'); card.className='tile';
    card.innerHTML=`<div class="top"><span class="id">#${p.id}</span><span class="name">${p.name}</span></div>
                    <img src="${p.img}" alt="${p.name}">`;
    card.addEventListener('click',()=>{
      const idx = selectedObjs.findIndex(x=>!x);
      if(idx===-1) return;
      const obj = currentPatternObjectById(p.id);
      if(!obj) return;
      selectedObjs[idx]=obj;
      renderSelection();
    });
    libEl.appendChild(card);
  });
}
function renderSelection(){
  clearSlotHighlight();
  for(let i=0;i<4;i++){
    const el=slots[i]; el.innerHTML='';
    const obj=selectedObjs[i];
    if(!obj){ el.classList.remove('filled'); el.innerHTML=`<span class="muted">Slot ${i+1}</span>`; }
    else{ el.classList.add('filled'); el.innerHTML=`<img src="${obj.img}" alt="Pattern ${obj.id}">`; }
  }
}

function setMode(m){
  if(isPlaying) stop();
  MODE=m; CONF=MODES[MODE]; PATTERNS=CONF.patterns.slice();
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.mode===MODE));
  document.getElementById('note').textContent = CONF.note;
  renderLibrary(); renderSelection(); // selection persists
}

// Controls
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>setMode(t.dataset.mode)));
document.getElementById('startBtn').addEventListener('click', start);
document.getElementById('stopBtn').addEventListener('click', stop);
document.getElementById('clearBtn').addEventListener('click', ()=>{ selectedObjs=[null,null,null,null]; renderSelection(); stop(); });
bpm.addEventListener('input', ()=>{ bpmVal.textContent=bpm.value; });
document.querySelectorAll('button[data-step]').forEach(btn=>btn.addEventListener('click',()=>{
  let v=parseInt(bpm.value,10)+parseInt(btn.dataset.step,10); v=Math.max(60, Math.min(200,v)); bpm.value=v; bpmVal.textContent=v;
}));
document.addEventListener('keydown',(e)=>{
  const tag=(document.activeElement&&document.activeElement.tagName)||'';
  const typing = ['INPUT','TEXTAREA','SELECT'].includes(tag) || (document.activeElement && document.activeElement.isContentEditable);
  if(typing) return;
  if(e.code==='Space'){ e.preventDefault(); isPlaying?stop():start(); }
  else if(e.code==='Escape'){ e.preventDefault(); selectedObjs=[null,null,null,null]; renderSelection(); stop(); }
  else if(e.code==='Backspace'){ e.preventDefault(); for(let i=3;i>=0;i--){ if(selectedObjs[i]){ selectedObjs[i]=null; break; } } renderSelection(); }
  else if(e.code==='ArrowLeft'){ let v=Math.max(60, parseInt(bpm.value,10)-1); bpm.value=v; bpmVal.textContent=v; }
  else if(e.code==='ArrowRight'){ let v=Math.min(200, parseInt(bpm.value,10)+1); bpm.value=v; bpmVal.textContent=v; }
});

// Init
setMode("4");
</script>
</body>
</html>
