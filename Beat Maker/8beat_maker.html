<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>drum_rhythm_mixer</title>
<style>
  :root { --bg:#0b0c10; --card:#111217; --muted:#9aa0a6; --accent:#22c55e; --danger:#ef4444; --border:#20232b; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  h1{font-size:22px;margin:0 0 8px 0}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .controls{gap:16px;margin-top:12px}
  .btn{padding:10px 16px;border-radius:14px;border:1px solid var(--border);background:var(--accent);color:#051b0d;font-weight:700;cursor:pointer}
  .btn.stop{background:var(--danger);color:#fff}
  .btn.clear{background:#1f2937;color:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .tile{background:#0f1117;border:1px solid var(--border);border-radius:14px;padding:10px;cursor:pointer;transition:transform .08s ease}
  .tile:hover{transform:translateY(-2px)}
  .tile .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tile .id{font-weight:800;font-size:14px}
  .tile .name{font-size:12px;color:var(--muted)}
  .tile img{width:100%;height:120px;display:block;object-fit:contain;border-radius:10px;background:#fff;border:1px solid #2b2f3a}
  .selection{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .slot{min-height:140px;border:1px dashed var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;padding:6px;background:#0f1117}
  .slot.filled{border-style:solid}
  .slot img{width:100%;height:120px;object-fit:contain;border-radius:8px;background:#fff;border:1px solid #2b2f3a}
  input[type=range]{accent-color:var(--accent)}
  .value{width:56px;text-align:right;font-feature-settings:'tnum';font-variant-numeric:tabular-nums}
  .warn{color:#fbbf24;font-size:12px;margin-left:6px}
  .note{font-size:12px;color:var(--muted);margin-top:8px}
  .fallback{background:#111;color:#fca5a5;border:1px solid #7f1d1d;padding:8px;border-radius:8px;font-size:12px}

.tile {
  transition: transform 0.1s ease-in-out;
}
.tile:active {
  transform: scale(1.05);
}


  .bpm-steps{display:flex;gap:6px;margin-left:10px}
  .bpm-step{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#1f2937;color:#e5e7eb;cursor:pointer;font-size:12px}
  .bpm-step:hover{transform:translateY(-1px)}


  /* highlight current playing slot */
  .slot.playing{
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 2px var(--accent) inset, 0 0 16px rgba(34,197,94,0.55);
    transition: box-shadow .08s ease, border-color .08s ease;
  }

</style>
</head>
<body>
  <div class="container">
    
    <div style="text-align:center; margin-bottom: 12px;">
      <h1 style="font-size:32px; line-height:1.1; margin:0; letter-spacing:0.3px;
                 background: linear-gradient(90deg,#fff,#22c55e 60%,#a7f3d0);
                 -webkit-background-clip:text; background-clip:text; color:transparent;">
        Nick Drums 8 Beat Maker
      </h1>
      <div class="muted" style="margin-top:6px;">Pick 1–4 tiles (duplicates allowed). Start to loop only the selected tiles. Clear to reset selection. BPM 60–200.</div>
    </div>
    

    <div id="imgError" class="fallback" style="display:none;margin-top:8px;">Image decode failed. Please re-download the HTML or open in a different browser.</div>

    <div class="row controls">
      <button id="startBtn" class="btn">Start</button>
      <button id="stopBtn" class="btn stop">Stop</button>
      <button id="clearBtn" style="background-color:#555;color:white;padding:6px 10px;border:none;border-radius:4px;cursor:pointer;">Clear Selection</button>
      <div class="row">
        <label for="bpm" class="muted">BPM</label>
        <input id="bpm" type="range" min="60" max="200" value="100" />
        <div id="bpmVal" class="value muted">100</div>
<div class="bpm-steps">
  <button type="button" class="bpm-step" data-step="-5">-5</button>
  <button type="button" class="bpm-step" data-step="-1">-1</button>
  <button type="button" class="bpm-step" data-step="1">+1</button>
  <button type="button" class="bpm-step" data-step="5">+5</button>
</div>
      </div>
      <div id="status" class="warn"></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="selection" id="selection">
        <div class="slot" id="slot0"><span class="muted">Slot 1</span></div>
        <div class="slot" id="slot1"><span class="muted">Slot 2</span></div>
        <div class="slot" id="slot2"><span class="muted">Slot 3</span></div>
        <div class="slot" id="slot3"><span class="muted">Slot 4</span></div>
      </div>
      <div class="note">Each tile is 2 beats (4 eighth notes). 4 tiles = 2 bars.</div>
    </div>

    <h2 style="margin-top:18px; font-size:18px;">Tiles</h2>
    <div class="grid cols-3" id="library"></div>
  </div>

<script>
const PATTERNS = [
  { id:1, name:"Pattern 1", img:'Images/8beat/1.png', hh:[0,1,2,3], sd:[2], bd:[] },
  { id:2, name:"Pattern 2", img:'Images/8beat/2.png', hh:[0,1,2,3], sd:[2], bd:[0] },
  { id:3, name:"Pattern 3", img:'Images/8beat/3.png', hh:[0,1,2,3], sd:[2], bd:[1] },
  { id:4, name:"Pattern 4", img:'Images/8beat/4.png', hh:[0,1,2,3], sd:[2], bd:[2] },
  { id:5, name:"Pattern 5", img:'Images/8beat/5.png', hh:[0,1,2,3], sd:[2], bd:[3] },
  { id:6, name:"Pattern 6", img:'Images/8beat/6.png', hh:[0,1,2,3], sd:[2], bd:[0, 1] },
  { id:7, name:"Pattern 7", img:'Images/8beat/7.png', hh:[0,1,2,3], sd:[2], bd:[0, 3] },
  { id:8, name:"Pattern 8", img:'Images/8beat/8.png', hh:[0,1,2,3], sd:[2], bd:[0, 2] },
  { id:9, name:"Pattern 9", img:'Images/8beat/9.png', hh:[0,1,2,3], sd:[2], bd:[1, 3] }
];

// WebAudio (same as previous)
let audioCtx, masterGain, reverb;
function ensureCtx(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(audioCtx.destination);
    reverb = audioCtx.createConvolver(); reverb.buffer = createReverbIR(audioCtx, 1.6, 2.8); reverb.connect(masterGain);
  }
  return audioCtx;
}
function createReverbIR(ctx, seconds=1.6, decay=2.6){
  const rate=ctx.sampleRate, length=Math.floor(rate*seconds);
  const impulse = ctx.createBuffer(2, length, rate);
  for(let ch=0; ch<2; ch++){ const data=impulse.getChannelData(ch); for(let i=0;i<length;i++){ const t=i/length; data[i]=(Math.random()*2-1)*Math.pow(1-t,decay);}}
  return impulse;
}
function playKick(time){
  const ctx=ensureCtx();
  const body=ctx.createOscillator(); body.type='sine'; body.frequency.setValueAtTime(140,time); body.frequency.exponentialRampToValueAtTime(50,time+0.12);
  const bg=ctx.createGain(); bg.gain.setValueAtTime(1.0,time); bg.gain.exponentialRampToValueAtTime(0.001,time+0.14); body.connect(bg);
  const click=ctx.createOscillator(); click.type='triangle'; click.frequency.setValueAtTime(2000,time);
  const cg=ctx.createGain(); cg.gain.setValueAtTime(0,time); cg.gain.exponentialRampToValueAtTime(0.001,time+0.02); click.connect(cg);
  const dry=ctx.createGain(); dry.gain.value=0.9; const wet=ctx.createGain(); wet.gain.value=0.18;
  bg.connect(dry).connect(masterGain); bg.connect(wet).connect(reverb); cg.connect(dry);
  body.start(time); body.stop(time+0.16); // click.start(time); // disabled // click.stop(time+0.05); // disabled
}
function playSnare(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.25, ctx.sampleRate); const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2200; bp.Q.value=0.7;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=900; const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.18);
  src.connect(bp).connect(hp).connect(g);
  const o=ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(180,time); const og=ctx.createGain(); og.gain.setValueAtTime(0.25,time); og.gain.exponentialRampToValueAtTime(0.001,time+0.12);
  o.connect(og);
  const dry=ctx.createGain(); dry.gain.value=0.7; const wet=ctx.createGain(); wet.gain.value=0.4;
  g.connect(dry).connect(masterGain); og.connect(dry); g.connect(wet).connect(reverb);
  src.start(time); src.stop(time+0.22); o.start(time); o.stop(time+0.12);
}
function playHat(time){
  const ctx=ensureCtx(); const nb=ctx.createBuffer(1, ctx.sampleRate*0.08, ctx.sampleRate); const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=8000; const g=ctx.createGain(); g.gain.setValueAtTime(0.6,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  src.connect(hp).connect(g);
  const dry=ctx.createGain(); dry.gain.value=0.6; const wet=ctx.createGain(); wet.gain.value=0.2;
  g.connect(dry).connect(masterGain); g.connect(wet).connect(reverb);
  src.start(time); src.stop(time+0.08);
}

// Metronome click for count‑in (accented beat 1)
function playClick(time, accent=false){
  const ctx = ensureCtx();
  // short blip (triangle) + tiny noise, lighter than hat
  const osc = ctx.createOscillator(); osc.type='triangle';
  osc.frequency.setValueAtTime(accent ? 2000 : 1400, time);
  const og = ctx.createGain();
  og.gain.setValueAtTime(accent ? 0.45 : 0.32, time);
  og.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
  osc.connect(og).connect(masterGain);
  // tiny noise layer
  const nb = ctx.createBuffer(1, ctx.sampleRate*0.03, ctx.sampleRate);
  const d = nb.getChannelData(0); for (let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const ns = ctx.createBufferSource(); ns.buffer = nb;
  const ng = ctx.createGain(); ng.gain.setValueAtTime(accent ? 0.15 : 0.1, time);
  ns.connect(ng).connect(masterGain);
  osc.start(time); osc.stop(time+0.06);
  ns.start(time); ns.stop(time+0.04);
}

// Sequencer
let bpm=100; const selected=[]; let isPlaying=false, nextNoteTime=0, currentStep=0, lookahead=null, countInTimer=null, isCountingIn=false;
const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn"); const stopBtn = document.getElementById("stopBtn"); const clearBtn=document.getElementById("clearBtn");
const bpmEl = document.getElementById("bpm"); const bpmVal=document.getElementById("bpmVal");

function stepDurationSec(){ return (60/bpm)/2; } // eighth
function buildCombined(){
  if (selected.length === 0) return null;
  const slots = Math.min(selected.length, 4);
  const total = slots * 4;
  const out = { hh: Array(total).fill(0), sd: Array(total).fill(0), bd: Array(total).fill(0) };
  for (let i = 0; i < slots; i++) {
    const pat = PATTERNS.find(p => p.id === selected[i]);
    if (!pat) continue;
    const base = i * 4;
    pat.hh.forEach(ix => { if (base + ix < total) out.hh[base + ix] = 1; });
    pat.sd.forEach(ix => { if (base + ix < total) out.sd[base + ix] = 1; });
    pat.bd.forEach(ix => { if (base + ix < total) out.bd[base + ix] = 1; });
  }
  return out;
}

// === Visual: highlight the currently playing slot ===
function updateSlotPlaying(step, total){
  try{
    const slotsCount = Math.min(selected.length, 4);
    const slotIndex = Math.floor((step % total) / 4);
    for(let i=0;i<4;i++){
      const el = slots[i];
      if(!el) continue;
      if(isPlaying && i === slotIndex && i < slotsCount){
        el.classList.add('playing');
      }else{
        el.classList.remove('playing');
      }
    }
  }catch(e){ /* no-op */ }
}
function clearSlotPlaying(){
  try{ for(let i=0;i<4;i++){ if(slots[i]) slots[i].classList.remove('playing'); } }catch(e){}
}

function schedule(){
  const ctx=ensureCtx(); const P=buildCombined(); if(!P) return; const stepDur=stepDurationSec();
  const total = P.hh.length;
  while(nextNoteTime < ctx.currentTime + 0.12){
    const step = currentStep % total; updateSlotPlaying(step, total); const t=nextNoteTime;
    if(P.hh[step]) playHat(t);
    if(P.sd[step]) playSnare(t);
    if(P.bd[step]) playKick(t);
    nextNoteTime += stepDur; currentStep = (currentStep + 1) % total;
  }
}

function updateSlotHighlight(activeIdx){
  for(let i=0;i<4;i++){
    const el = document.getElementById('slot'+i);
    if(!el) continue;
    if(i===activeIdx){ el.classList.add('playing'); }
    else{ el.classList.remove('playing'); }
  }
}

function start(){
  if (selected.length === 0) { statusEl.textContent = 'Pick at least 1 tile.'; return; }
  const ctx=ensureCtx(); if(ctx.state==='suspended') ctx.resume(); statusEl.textContent='';
  isPlaying=true; currentStep=0; nextNoteTime=ctx.currentTime+0.05; lookahead=setInterval(schedule,25);
  startBtn.classList.add('stop'); startBtn.textContent='Playing...';
}
function stop(){
  clearSlotPlaying();
  if(lookahead) clearInterval(lookahead); lookahead=null; isPlaying=false;
  startBtn.classList.remove('stop'); startBtn.textContent='Start';
}

// UI
const libEl=document.getElementById('library');
const slots=[document.getElementById('slot0'),document.getElementById('slot1'),document.getElementById('slot2'),document.getElementById('slot3')];
function renderSelection(){
  clearSlotPlaying();
  for(let i=0;i<4;i++){
    const slot=slots[i]; slot.innerHTML='';
    const id=selected[i];
    if(id){
      const pat=PATTERNS.find(p=>p.id===id);
      const img=new Image(); img.src=pat.img; img.onload=()=>{}; img.onerror=()=>{ document.getElementById('imgError').style.display='block'; };
      slot.classList.add('filled'); slot.appendChild(img);
    }else{
      slot.classList.remove('filled'); const span=document.createElement('span'); span.className='muted'; span.textContent='Slot '+(i+1); slot.appendChild(span);
    }
  }
}
PATTERNS.forEach(p=>{
  const card=document.createElement('div'); card.className='tile';
  const top=document.createElement('div'); top.className='top';
  const idEl=document.createElement('div'); idEl.className='id'; idEl.textContent='#'+p.id;
  const nameEl=document.createElement('div'); nameEl.className='name'; nameEl.textContent=p.name;
  top.appendChild(idEl); top.appendChild(nameEl);
  const img=new Image(); img.src=p.img; img.onload=()=>{}; img.onerror=()=>{ document.getElementById('imgError').style.display='block'; };
  card.appendChild(top); card.appendChild(img);
  card.onclick=()=>{ if(selected.length>=4) return; selected.push(p.id); renderSelection(); };
  libEl.appendChild(card);
});
bpmEl.addEventListener('input', e=>{ bpm=parseInt(e.target.value,10); bpmVal.textContent=bpm; });
startBtn.addEventListener('click', start);
stopBtn.addEventListener('click', stop);
clearBtn.addEventListener('click', ()=>{ selected.length=0; renderSelection(); stop(); statusEl.textContent=''; });
renderSelection();

document.getElementById('clearBtn').addEventListener('click', () => {
  const slots = document.querySelectorAll('.slot');
  slots.forEach((slot, index) => {
    slot.innerHTML = `<span class="muted">Slot ${index + 1}</span>`;
    slot.classList.remove('filled');
  });
});

</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const bpmDisplay = document.getElementById('bpm-display');
  let bpm = parseInt(bpmDisplay.textContent, 10);

  function updateBPM(newBpm) {
    bpm = Math.max(20, Math.min(300, newBpm)); // clamp between 20 and 300
    bpmDisplay.textContent = bpm;
    const bpmInput = document.getElementById('bpm');
    if (bpmInput) bpmInput.value = bpm;
  }

  document.getElementById('bpm-minus-5').addEventListener('click', () => updateBPM(bpm - 5));
  document.getElementById('bpm-minus-1').addEventListener('click', () => updateBPM(bpm - 1));
  document.getElementById('bpm-plus-1').addEventListener('click', () => updateBPM(bpm + 1));
  document.getElementById('bpm-plus-5').addEventListener('click', () => updateBPM(bpm + 5));

  // Keyboard arrow control
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      updateBPM(bpm - 1);
    } else if (e.key === 'ArrowRight') {
      updateBPM(bpm + 1);
    }
  });
});
</script>


<script>
(function(){
  const bpmInput = document.getElementById('bpm');
  const bpmVal = document.getElementById('bpmVal');
  if(!bpmInput || !bpmVal) return;

  const clamp = (v) => Math.min(parseInt(bpmInput.max||200,10), Math.max(parseInt(bpmInput.min||60,10), Math.round(v)));

  function setBPM(v){
    const nv = clamp(v);
    if(String(bpmInput.value) !== String(nv)){
      bpmInput.value = nv;
      const evt = new Event('input', {bubbles:true});
      bpmInput.dispatchEvent(evt);
    }
    bpmVal.textContent = String(nv);
  }

  // Sync display initially and on input (in case original code already does this)
  setBPM(bpmInput.value);
  bpmInput.addEventListener('input', () => bpmVal.textContent = String(clamp(bpmInput.value)));

  // Step buttons
  document.querySelectorAll('.bpm-step').forEach(btn => {
    btn.addEventListener('click', () => {
      const step = parseInt(btn.dataset.step, 10) || 0;
      setBPM(parseInt(bpmInput.value,10) + step);
    });
  });

  // Keyboard: Left/Right adjust by 1
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      setBPM(parseInt(bpmInput.value,10) - 1);
    } else if (e.key === 'ArrowRight') {
      setBPM(parseInt(bpmInput.value,10) + 1);
    }
  });
})();
</script>


<script>
// Spacebar toggles Start/Stop (ignored in text inputs)
document.addEventListener('keydown', (e) => {
  const tag = (document.activeElement && document.activeElement.tagName) || '';
  const isTyping = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || (document.activeElement && document.activeElement.isContentEditable);
  if (e.code === 'Space' && !isTyping) {
    e.preventDefault();
    if (typeof isPlaying !== 'undefined') {
      if (isPlaying) { if (typeof stop === 'function') stop(); }
      else { if (typeof start === 'function') start(); }
    }
  }
});
</script>
</body>
</html>
