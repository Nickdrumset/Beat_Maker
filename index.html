<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Nick Drum Integrated</title>
<style>
  :root{
    --bg-grad: linear-gradient(135deg, #bfeee3 0%, #ffd8ba 50%, #bcd9f5 100%);
    --card: rgba(255,255,255,0.65);
    --section: rgba(245,248,250,.85);
    --text: #1c2c38;
    --sub: #385858;

    --radius: clamp(12px, 1.6vw, 16px);
    --gap: clamp(12px, 2.2vw, 20px);

    /* 타이틀 폰트 사이즈 */
    --fs-title: clamp(48px, 8vw, 96px);

    --line: rgba(100,150,200,0.22);
    --line-strong: rgba(100,150,200,0.35);
    --hover: rgba(200,230,250,0.15);
    --chip-bg: rgba(200,230,250,.32);
  }

  *{ box-sizing: border-box; }
  html, body { height: 100%; min-height: 100dvh; }
  body{
    margin:0;
    color:var(--text);
    background: var(--bg-grad) fixed;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    overflow:hidden;
  }

  /* 유틸리티: 뷰 전환용 */
  .hidden { display: none !important; }

  #stage{
    width: 100vw;
    height: 100vh;
    height: 100dvh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    overflow: hidden;
  }

  #scaleWrap { transform-origin: top center; }

  /* --- Header --- */
  header{
    padding: clamp(24px, 5vw, 48px) 20px clamp(16px, 3vw, 24px);
    text-align:center; position:relative; overflow:hidden; isolation:isolate;
  }
  h1.title{
    margin:0;
    font-size: var(--fs-title);
    font-weight: 800;
    background: linear-gradient(90deg, #ffffff, #cfeae1);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    -webkit-text-fill-color:transparent; -webkit-text-stroke:1px black;
    line-height: 1.1;
    white-space: nowrap; 
    letter-spacing: -1px; 
  }

  main{ 
    max-width: min(1400px, 96vw); 
    margin: 0 auto clamp(36px,6vw,56px); 
    padding: 0 clamp(8px,2vw,16px); 
  }

  /* --- Layout Split --- */
  .layout-split {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }

  /* 가로 모드 (4:3 이상) */
  @media (min-aspect-ratio: 4/3) {
    .layout-split {
      display: grid;
      grid-template-columns: 300px 1fr;
      align-items: stretch;
      gap: clamp(30px, 4vw, 50px);
      margin-top: 4vh;
    }
    
    .panel-left {
      display: flex;
      flex-direction: column;
    }
    
    header {
      padding: 0 0 24px 0;
      text-align: left;
    }
    h1.title {
      font-size: 42px;
      white-space: normal;
      line-height: 1.1;
    }

    .panel-right {
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      /* Maker 모드일 때 스크롤 필요할 수 있음 */
      overflow-y: auto;
      max-height: 90vh; 
    }
    .panel-right::-webkit-scrollbar { display: none; }

    .panel-left .controlsWrap {
      flex-direction: column;
      align-items: stretch;
      gap: 24px;
    }
    
    .panel-left #bpmStepGroup {
      display: grid !important;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-left: 0 !important;
      width: 100%;
    }

    .panel-left #transportRow {
      flex-direction: column;
      align-items: stretch;
    }
    .panel-left .modeToggle {
      margin-right: 0;
      width: 100%;
      margin-bottom: 8px;
    }
    .panel-left .mode-btn { flex: 1; }
    .panel-left #startBtn, .panel-left #stopBtn, .panel-left #clearBtn { width: 100%; }
    
    .panel-left #bpmRow { flex-direction: column; align-items: stretch; }
    .panel-left input[type=range] { width: 100%; }
  }

  .card{
    background: var(--card);
    backdrop-filter: blur(8px);
    border: 0;
    border-radius: var(--radius);
    box-shadow: 0 12px 28px rgba(100,150,200,.22);
    padding: clamp(18px, 2.8vw, 32px);
  }

  .row{ display:flex; gap: clamp(8px,1.4vw,12px); align-items:center; flex-wrap: wrap; }
  .controlsWrap{ gap: var(--gap); justify-content: space-between; }
  
  .chip{ display:inline-block; font-size: 12px; color: var(--sub); padding: 2px 8px; border-radius: 999px; background: var(--chip-bg); border:1px solid rgba(100,150,200,.18); }

  /* Buttons */
  .btn{
    min-height: clamp(38px, 5.2vw, 48px);
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    border-radius: clamp(10px, 1.5vw, 12px);
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.55);
    color: var(--text);
    padding: 10px 16px;
    font-weight: 700;
    cursor:pointer;
    transition: transform .15s ease, box-shadow .2s ease, background .25s ease, border-color .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(100,150,200,0.15); background: var(--hover); border-color: var(--line-strong); }

  .modeToggle{
    display:flex;
    align-items:center;
    gap:8px;
    margin-right:16px;
  }
  .mode-btn{
    min-height: 48px;
    padding: 9px 18px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.55);
    font-size: 20px;
    font-weight: 600;
    color: var(--sub);
    cursor:pointer;
    transition: all .2s ease;
    display: flex; align-items: center; justify-content: center;
  }
  .mode-btn:hover{
    background: var(--hover);
    border-color: var(--line-strong);
    box-shadow: 0 3px 8px rgba(100,150,200,0.18);
    transform: translateY(-1px);
  }
  .mode-btn.active{
    background: rgba(255,255,255,0.9);
    box-shadow: 0 0 0 2px rgba(100,150,200,0.25) inset;
    border-color: var(--line-strong);
  }

  input[type=range]{ width: 220px; accent-color: #6aa9e9; }
  .value{ width:56px; text-align:right; font-feature-settings:'tnum'; font-variant-numeric:tabular-nums; color: var(--sub); }
  .warn{ color:#a15c00; font-size: 12px; margin-left: 6px; }

  /* --- Study View Specifics (Slots) --- */
  .study-selection { display:flex; flex-direction:column; gap: var(--gap); }
  .study-row { display:grid; gap: var(--gap); }
  .study-row.row-1 { grid-template-columns: repeat(4, 1fr); }
  @media (min-aspect-ratio: 4/3) {
    .study-row.row-1 { grid-template-columns: 1fr 3fr; }
  }
  .study-row.row-2, .study-row.row-3{ grid-template-columns: repeat(4, 1fr); }

  /* --- Maker View Specifics (Slots & Lib) --- */
  .maker-selection { display:grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); }
  @media (min-aspect-ratio: 4/3) {
     /* Maker view slot aspect ratio tweak */
    .maker-selection .slot { aspect-ratio: 16/11; } 
  }
  
  h2.lib-title { margin-top:18px; font-size:18px; margin-bottom: 12px; }
  .grid{ display:grid; gap: var(--gap); }
  .grid.cols-3{ grid-template-columns: minmax(0, 1fr); } 
  .tile-row{
    display:flex;
    gap: var(--gap);
    margin-bottom: calc(var(--gap) * 0.45); 
    justify-content:flex-start;
    align-items:flex-start;
  }
  .tile-row:last-child{ margin-bottom: 0; }
  .tile{
    background: rgba(255,255,255,.55);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 8px;
    cursor:pointer;
    transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    flex: 0 0 calc((100% - 3 * var(--gap)) / 4);
    max-width: calc((100% - 3 * var(--gap)) / 4);
  }
  .tile:hover{
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(100,150,200,0.18);
    background: var(--hover);
    border-color: var(--line-strong);
  }
  .tile img{
    width: 100%; height: auto; object-fit: contain;
    border-radius: 10px; background:#fff; border:1px solid rgba(100,150,200,.26);
  }

  /* --- Shared Slot Styles --- */
  .slot{
    aspect-ratio: 16 / 10;
    border:1px solid var(--line);
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center; padding:6px;
    background: rgba(255,255,255,.55);
    transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
    overflow: hidden;
  }
  .repeat{ font-size: 14px; font-weight: 600; color: var(--sub); opacity: .75; display: flex; align-items: center; }
  
  .slot.filled{ border-color: var(--line-strong); }
  .slot img{ width:100%; height:100%; object-fit: contain; border-radius: 8px; background:#fff; border:1px solid rgba(100,150,200,.26); }
  .slot.playing{ border-color: #6aa9e9 !important; box-shadow: 0 0 0 2px #6aa9e9 inset, 0 0 16px rgba(106,169,233,0.45); }

  /* Tabs */
  .tabs{ display:flex; gap: var(--gap); margin-bottom: clamp(12px,1.8vw,16px); }
  .tab{
    flex:1; text-align:center; cursor:pointer;
    padding: 12px; border-radius: 12px;
    background: rgba(255,255,255,.45);
    color: var(--text);
    border: 1px solid var(--line);
    transition: background .2s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .tab:hover{ background: var(--hover); border-color: var(--line-strong); }
  .tab.active{ background: rgba(255,255,255,.65); box-shadow: 0 0 0 2px rgba(100,150,200,.22) inset; }

  .note{ font-size: 12px; color: var(--sub); margin-top: 8px; }

  /* Mobile / Portrait Overrides */
  @media (hover: none) and (pointer: coarse) and (max-width: 600px){
    body{ overflow:auto; }
    #stage{ align-items: flex-start; }
    #scaleWrap{ transform: none !important; width: 100% !important; }
    
    .study-row{ grid-template-columns: 1fr; }
    .study-row.row-1 { grid-template-columns: 1fr !important; }
    .maker-selection { grid-template-columns: 1fr; }

    header{ padding-top: 28px; }
    .layout-split { display: flex; flex-direction: column; margin-top: 0; }
    .panel-left .controlsWrap { flex-direction: row; }
    .panel-left #bpmStepGroup { display: flex !important; }
    .panel-left #transportRow { flex-direction: row; }
  }
 
  body.fs-on.portrait{
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }
  @media (orientation: portrait){
    #stage{ align-items: flex-start; }
    #scaleWrap img{ max-width: 100%; height: auto; object-fit: contain; }
    .layout-split { display: flex; flex-direction: column; grid-template-columns: none; margin-top: 0; }
    header { text-align: center; padding-bottom: clamp(16px, 3vw, 24px); }
    .panel-left .controlsWrap { flex-direction: row; align-items: center; }
    .panel-left #transportRow { flex-direction: row; }
    .panel-left #bpmRow { flex-direction: row; }
    .panel-left #bpmStepGroup { display: flex !important; margin-left: 10px !important; }
    h1.title { font-size: var(--fs-title); white-space: nowrap; }
    .panel-right { padding-top: 0; overflow-y: visible; }
  }

/* Fullscreen button */
.fs-btn {
  position: fixed; top: 14px; right: 14px;
  display: inline-grid; place-items: center;
  width: 44px; height: 44px;
  border: none; border-radius: 9999px;
  background: rgba(0,0,0,0.6); color: #fff;
  cursor: pointer; transition: all 120ms ease;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25); z-index: 1000;
}
.fs-btn:hover { background: rgba(0,0,0,0.75); transform: translateY(-1px); }
.icon { width: 22px; height: 22px; display: inline; }
.icon.exit { display: none; }
</style>
</head>
<body>
<div id="stage">
  <div id="scaleWrap">
    
    <main>
      <div class="layout-split">
        
        <div class="panel-left">
          <header>
            <h1 class="title" id="mainTitle">4 8 16 Beat Exercise</h1>
          </header>

          <div class="card controls">
            <div class="row controlsWrap">
              
              <div class="row" id="transportRow" style="width:100%">
                <div class="modeToggle">
                  <button type="button" class="mode-btn active" id="btnModeStudy">Study</button>
                  <button type="button" class="mode-btn" id="btnModeMaker">Maker</button>
                </div>
                <div style="display:flex; gap:8px; width:100%; flex-wrap:wrap;">
                   <button id="startBtn" class="btn" style="flex:1">Start</button>
                   <button id="stopBtn" class="btn" style="flex:1">Stop</button>
                   <button id="clearBtn" class="btn clear hidden" style="flex:1">Clear</button>
                </div>
              </div>

              <div class="row" id="bpmRow" style="width:100%">
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                  <span class="chip">BPM</span>
                  <div id="bpmVal" class="value">60</div>
                </div>
                <input id="bpm" type="range" min="60" max="200" value="60" style="width:100%" />
                
                <div class="row" id="bpmStepGroup" style="gap:6px;margin-left:0;width:100%;">
                  <button type="button" class="btn clear" data-step="-5" style="flex:1">-5</button>
                  <button type="button" class="btn clear" data-step="5" style="flex:1">+5</button>
                  <button type="button" class="btn clear" data-step="-1" style="flex:1">-1</button>
                  <button type="button" class="btn clear" data-step="1" style="flex:1">+1</button>
                </div>
                <div id="status" class="warn"></div>
              </div>

            </div>
          </div>
        </div>

        <div class="panel-right">
          
          <div class="tabs">
            <div class="tab active" data-mode="4">4 Beat</div>
            <div class="tab" data-mode="8">8 Beat</div>
            <div class="tab" data-mode="16">16 Beat</div>
          </div>

          <div id="view-study">
            <div class="card" style="margin-bottom: var(--gap);">
              <div class="study-selection" id="studySelection">
                <div class="study-row row-1">
                  <div class="slot" id="s-slot0"><span class="chip">Slot 1</span></div>
                  <div class="repeat">2 times each</div>
                </div>
                <div class="study-row row-2">
                  <div class="slot" id="s-slot1"><span class="chip">Slot 2</span></div>
                  <div class="slot" id="s-slot2"><span class="chip">Slot 3</span></div>
                  <div class="slot" id="s-slot3"><span class="chip">Slot 4</span></div>
                  <div class="slot" id="s-slot4"><span class="chip">Slot 5</span></div>
                </div>
                <div class="study-row row-3">
                  <div class="slot" id="s-slot5"><span class="chip">Slot 6</span></div>
                  <div class="slot" id="s-slot6"><span class="chip">Slot 7</span></div>
                  <div class="slot" id="s-slot7"><span class="chip">Slot 8</span></div>
                  <div class="slot" id="s-slot8"><span class="chip">Slot 9</span></div>
                </div>
              </div>
              <div class="note" id="studyNote"></div>
            </div>
          </div>

          <div id="view-maker" class="hidden">
            <div class="card" style="margin-bottom: var(--gap);">
              <div class="maker-selection" id="makerSelection">
                <div class="slot" id="m-slot0"><span class="chip">Slot 1</span></div>
                <div class="slot" id="m-slot1"><span class="chip">Slot 2</span></div>
                <div class="slot" id="m-slot2"><span class="chip">Slot 3</span></div>
                <div class="slot" id="m-slot3"><span class="chip">Slot 4</span></div>
              </div>
              <div class="note" id="makerNote"></div>
            </div>

            <h2 class="lib-title">Tiles</h2>
            <div class="grid cols-3 card" id="library" style="padding: clamp(12px,2vw,20px);"></div>
          </div>

        </div>

      </div> </main>

 </div>
</div>

<button id="fsBtn" class="fs-btn" aria-label="전체화면 전환 (F)" title="전체화면 전환 (F)" aria-pressed="false">
  <svg class="icon enter" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M4 10V4h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 14v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M4 4l7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <path d="M20 20l-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <svg class="icon exit" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M10 4H4v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M14 20h6v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M11 11L4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <path d="M13 13l7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>

<script>
/* ==== Data: Patterns ==== */
const P4 = [
  { id:0, name:"Pattern 1", img:"Images/4beat/1.png", hh:[0,2], sd:[2], bd:[] },
  { id:1, name:"Pattern 2", img:"Images/4beat/2.png", hh:[0,2], sd:[2], bd:[0] },
  { id:2, name:"Pattern 3", img:"Images/4beat/3.png", hh:[0,2], sd:[2], bd:[1] },
  { id:3, name:"Pattern 4", img:"Images/4beat/4.png", hh:[0,2], sd:[2], bd:[2] },
  { id:4, name:"Pattern 5", img:"Images/4beat/5.png", hh:[0,2], sd:[2], bd:[3] },
  { id:5, name:"Pattern 6", img:"Images/4beat/6.png", hh:[0,2], sd:[2], bd:[0, 1] },
  { id:6, name:"Pattern 7", img:"Images/4beat/7.png", hh:[0,2], sd:[2], bd:[0, 3] },
  { id:7, name:"Pattern 8", img:"Images/4beat/8.png", hh:[0,2], sd:[2], bd:[0, 2] },
  { id:8, name:"Pattern 9", img:"Images/4beat/9.png", hh:[0,2], sd:[2], bd:[1, 3] }
];
const P8 = [
  { id:0, name:"Pattern 1", img:'Images/8beat/1.png', hh:[0,1,2,3], sd:[2], bd:[] },
  { id:1, name:"Pattern 2", img:'Images/8beat/2.png', hh:[0,1,2,3], sd:[2], bd:[0] },
  { id:2, name:"Pattern 3", img:'Images/8beat/3.png', hh:[0,1,2,3], sd:[2], bd:[1] },
  { id:3, name:"Pattern 4", img:'Images/8beat/4.png', hh:[0,1,2,3], sd:[2], bd:[2] },
  { id:4, name:"Pattern 5", img:'Images/8beat/5.png', hh:[0,1,2,3], sd:[2], bd:[3] },
  { id:5, name:"Pattern 6", img:'Images/8beat/6.png', hh:[0,1,2,3], sd:[2], bd:[0, 1] },
  { id:6, name:"Pattern 7", img:'Images/8beat/7.png', hh:[0,1,2,3], sd:[2], bd:[0, 3] },
  { id:7, name:"Pattern 8", img:'Images/8beat/8.png', hh:[0,1,2,3], sd:[2], bd:[0, 2] },
  { id:8, name:"Pattern 9", img:'Images/8beat/9.png', hh:[0,1,2,3], sd:[2], bd:[1, 3] }
];
const P16 = [
  { id:0, name:'Pattern 1', img:'Images/16beat/1.png', hh:[0,1,2,3,4,5,6,7], bd:[], sd:[4] },
  { id:1, name:'Pattern 2', img:'Images/16beat/2.png', hh:[0,1,2,3,4,5,6,7], bd:[0], sd:[4] },
  { id:2, name:'Pattern 3', img:'Images/16beat/3.png', hh:[0,1,2,3,4,5,6,7], bd:[2], sd:[4] },
  { id:3, name:'Pattern 4', img:'Images/16beat/4.png', hh:[0,1,2,3,4,5,6,7], bd:[4], sd:[4] },
  { id:4, name:'Pattern 5', img:'Images/16beat/5.png', hh:[0,1,2,3,4,5,6,7], bd:[6], sd:[4] },
  { id:5, name:'Pattern 6', img:'Images/16beat/6.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 2], sd:[4] },
  { id:6, name:'Pattern 7', img:'Images/16beat/7.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 6], sd:[4] },
  { id:7, name:'Pattern 8', img:'Images/16beat/8.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 4], sd:[4] },
  { id:8, name:'Pattern 9', img:'Images/16beat/9.png', hh:[0,1,2,3,4,5,6,7], bd:[2, 6], sd:[4] }
];

const MODES = {
  "4":  { title:"4 Beat",  patterns:P4,  tileSteps:4,  stepType:"eighth",    note:"" },
  "8":  { title:"8 Beat",  patterns:P8,  tileSteps:4,  stepType:"eighth",    note:"" },
  "16": { title:"16 Beat", patterns:P16, tileSteps:8,  stepType:"sixteenth", note:"" }
};

/* ==== Application State ==== */
let APP_MODE = "study"; // "study" or "maker"
let BEAT_MODE = "4"; // "4", "8", "16"

let CONF = MODES[BEAT_MODE];
let PATTERNS = CONF.patterns.slice();

// Study State
let studySelectedObjs = [null,null,null,null,null,null,null,null,null]; // 9 slots
let studySlotIndex=0, studySlotRepeat=0, studyStepInSlot=0;
let isIntroPhase=false, introStep=0;

// Maker State
let makerSelectedObjs = [null,null,null,null]; // 4 slots
let makerCurrentStep=0;

// Shared Playback State
let isPlaying = false;
let nextNoteTime = 0;
let timer = null;

/* ==== DOM Elements ==== */
const titleEl = document.getElementById('mainTitle');
const bpm = document.getElementById('bpm'), bpmVal = document.getElementById('bpmVal');
const statusEl = document.getElementById('status');

// Buttons
const btnModeStudy = document.getElementById('btnModeStudy');
const btnModeMaker = document.getElementById('btnModeMaker');
const clearBtn = document.getElementById('clearBtn');

// Views
const viewStudy = document.getElementById('view-study');
const viewMaker = document.getElementById('view-maker');

// Study Elements
const studySlots = [
  document.getElementById('s-slot0'), document.getElementById('s-slot1'), document.getElementById('s-slot2'),
  document.getElementById('s-slot3'), document.getElementById('s-slot4'), document.getElementById('s-slot5'),
  document.getElementById('s-slot6'), document.getElementById('s-slot7'), document.getElementById('s-slot8')
];
const studyNoteEl = document.getElementById('studyNote');

// Maker Elements
const makerSlots = [
  document.getElementById('m-slot0'), document.getElementById('m-slot1'),
  document.getElementById('m-slot2'), document.getElementById('m-slot3')
];
const makerNoteEl = document.getElementById('makerNote');
const libEl = document.getElementById('library');


/* ==== Logic Helpers ==== */
function toSixteenthPattern(p, stepType, tileSteps){
  const mul = (stepType==='eighth') ? 2 : 1;
  const map = arr => (arr||[]).map(v => v*mul);
  return { id:p.id, name:p.name, img:p.img, hh:map(p.hh), sd:map(p.sd), bd:map(p.bd), TILE_STEPS: tileSteps * mul };
}
function currentPatternObjectById(id){
  const conf = MODES[BEAT_MODE];
  const src = conf.patterns.find(x=>x.id===id);
  if(!src) return null;
  return toSixteenthPattern(src, conf.stepType, conf.tileSteps);
}
function stepDurationSec(){
  const v=parseInt(bpm.value,10);
  return 60/(v*4);
}

/* ==== Audio System ==== */
let audioCtx, masterGain, reverb;
function ensureCtx(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(audioCtx.destination);
    reverb = audioCtx.createConvolver(); reverb.buffer = createReverbIR(audioCtx, 1.5, 2.5); reverb.connect(masterGain);
  }
  return audioCtx;
}
function createReverbIR(ctx, seconds=1.5, decay=2.5){
  const rate=ctx.sampleRate, length=Math.floor(rate*seconds);
  const buf=ctx.createBuffer(2,length,rate);
  for(let ch=0;ch<2;ch++){
    const d=buf.getChannelData(ch);
    for(let i=0;i<length;i++){ const t=i/length; d[i]=(Math.random()*2-1)*Math.pow(1-t,decay); }
  }
  return buf;
}
function playKick(time){
  const ctx=ensureCtx();
  const osc=ctx.createOscillator(); osc.type='sine';
  osc.frequency.setValueAtTime(150,time); osc.frequency.exponentialRampToValueAtTime(50,time+0.12);
  const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.14);
  osc.connect(g); g.connect(masterGain); g.connect(reverb);
  osc.start(time); osc.stop(time+0.16);
}
function playSnare(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.25, ctx.sampleRate);
  const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb;
  const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.7;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=900;
  const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.18);
  src.connect(bp).connect(hp).connect(g); g.connect(masterGain); g.connect(reverb);
  src.start(time); src.stop(time+0.22);
}
function playHat(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.08, ctx.sampleRate);
  const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=8000;
  const g=ctx.createGain(); g.gain.setValueAtTime(0.6,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  src.connect(hp).connect(g); g.connect(masterGain); g.connect(reverb);
  src.start(time); src.stop(time+0.08);
}

/* ==== Scheduler Logic ==== */

// STUDY MODE Scheduler
function scheduleStudy(ctx, stepDur){
  const INTRO_STEPS = 16;
  const INTRO_CLICK_INTERVAL = 4;

  while(nextNoteTime < ctx.currentTime + 0.12){
    const t = nextNoteTime;

    // 1) 예비박
    if(isIntroPhase){
      if(introStep % INTRO_CLICK_INTERVAL === 0){ playHat(t); }
      introStep++; nextNoteTime += stepDur;
      if(introStep >= INTRO_STEPS){
        isIntroPhase = false;
        clearSlotHighlights();
        studySlotIndex=0; studySlotRepeat=0; studyStepInSlot=0;
      }
      continue;
    }

    // 2) Main Patterns
    const slotOrder = []; 
    for(let i=0; i<studySelectedObjs.length; i++){ if(studySelectedObjs[i]) slotOrder.push(i); }
    
    if(slotOrder.length === 0){ stop(); break; }

    if(studySlotIndex >= slotOrder.length){
      const curBpm = parseInt(bpm.value, 10);
      if(curBpm < 200){
        const newBpm = Math.min(200, curBpm + 10);
        bpm.value = newBpm; bpmVal.textContent = newBpm;
      }
      isIntroPhase = true; introStep = 0;
      studySlotIndex = 0; studySlotRepeat = 0; studyStepInSlot = 0;
      clearSlotHighlights();
      continue;
    }

    const idx = slotOrder[studySlotIndex];
    const tile = studySelectedObjs[idx];
    if(!tile){
      studySlotIndex++; studySlotRepeat=0; studyStepInSlot=0; continue;
    }
    const stepsInTile = tile.TILE_STEPS || 0;
    
    updateStudyHighlight(idx);

    const s = studyStepInSlot;
    if(tile.hh && tile.hh.includes(s)) playHat(t);
    if(tile.sd && tile.sd.includes(s)) playSnare(t);
    if(tile.bd && tile.bd.includes(s)) playKick(t);

    studyStepInSlot++; nextNoteTime += stepDur;
    if(studyStepInSlot >= stepsInTile){
      studyStepInSlot = 0; studySlotRepeat++;
      if(studySlotRepeat >= 2){ studySlotRepeat=0; studySlotIndex++; }
    }
  }
}

// MAKER MODE Scheduler
function buildMakerCombined(){
  const chosen = makerSelectedObjs.filter(o=>o);
  if(chosen.length===0) return null;
  const total = chosen.reduce((acc,o)=>acc+o.TILE_STEPS, 0);
  const out = { total, hh:Array(total).fill(0), sd:Array(total).fill(0), bd:Array(total).fill(0), tileBounds:[] };
  let base=0;
  chosen.forEach(o=>{
    o.hh.forEach(ix=>{ if(base+ix<total) out.hh[base+ix]=1; });
    o.sd.forEach(ix=>{ if(base+ix<total) out.sd[base+ix]=1; });
    o.bd.forEach(ix=>{ if(base+ix<total) out.bd[base+ix]=1; });
    base += o.TILE_STEPS;
    out.tileBounds.push(base);
  });
  return out;
}

function scheduleMaker(ctx, stepDur){
  const P = buildMakerCombined(); 
  if(!P) return; // Should technically stop if nothing selected, but we'll just idle
  const total = P.total;

  while(nextNoteTime < ctx.currentTime + 0.12){
    const step = makerCurrentStep % total;
    // Highlight determination
    let tileIdx = 0; 
    while(tileIdx < P.tileBounds.length && step >= P.tileBounds[tileIdx]) tileIdx++;
    updateMakerHighlight(tileIdx);

    const t=nextNoteTime;
    if(P.hh[step]) playHat(t);
    if(P.sd[step]) playSnare(t);
    if(P.bd[step]) playKick(t);
    nextNoteTime += stepDur; 
    makerCurrentStep = (makerCurrentStep + 1) % total;
  }
}

// Main Scheduler
function schedule(){
  const ctx = ensureCtx();
  const stepDur = stepDurationSec();
  if(APP_MODE === "study") scheduleStudy(ctx, stepDur);
  else scheduleMaker(ctx, stepDur);
}

/* ==== Render & UI ==== */
function clearSlotHighlights(){
  studySlots.forEach(el=>el.classList.remove('playing'));
  makerSlots.forEach(el=>el.classList.remove('playing'));
}
function updateStudyHighlight(idx){
  clearSlotHighlights();
  if(studySlots[idx]) studySlots[idx].classList.add('playing');
}
function updateMakerHighlight(idx){
  clearSlotHighlights();
  if(makerSlots[idx]) makerSlots[idx].classList.add('playing');
}

// Render Study Slots
function renderStudySelection(){
  for(let i=0; i<studySlots.length; i++){
    const el=studySlots[i]; if(!el) continue;
    el.innerHTML='';
    const obj=studySelectedObjs[i];
    if(!obj){
      el.classList.remove('filled');
      el.innerHTML=`<span class="chip">Slot ${i+1}</span>`;
    } else {
      el.classList.add('filled');
      el.innerHTML=`<img src="${obj.img}" alt="Pattern ${obj.id}">`;
    }
  }
}

// Render Maker Slots
function renderMakerSelection(){
  for(let i=0; i<makerSlots.length; i++){
    const el=makerSlots[i]; el.innerHTML='';
    const obj=makerSelectedObjs[i];
    if(!obj){ 
      el.classList.remove('filled'); el.innerHTML=`<span class="chip">Slot ${i+1}</span>`; 
    } else { 
      el.classList.add('filled'); el.innerHTML=`<img src="${obj.img}" alt="Pattern ${obj.id}">`; 
    }
  }
}

// Render Maker Library
function renderMakerLibrary(){
  libEl.innerHTML = '';
  const groups = [[0], [1, 2, 3, 4], [5, 6, 7, 8]];
  groups.forEach(indices => {
    const row = document.createElement('div'); row.className = 'tile-row';
    indices.forEach(i => {
      const p = PATTERNS[i]; if (!p) return;
      const card = document.createElement('div'); card.className = 'tile';
      card.innerHTML = `<img src="${p.img}" alt="${p.name}">`;
      card.addEventListener('click', () => {
        const idx = makerSelectedObjs.findIndex(x => !x);
        if (idx === -1) return;
        const obj = currentPatternObjectById(p.id);
        if (!obj) return;
        makerSelectedObjs[idx] = obj;
        renderMakerSelection();
      });
      row.appendChild(card);
    });
    libEl.appendChild(row);
  });
}

/* ==== Control Flow ==== */
function start(){
  // check current mode reqs
  if(APP_MODE === 'study'){
     const activeCount = studySelectedObjs.filter(o=>o).length;
     if(activeCount===0){ statusEl.textContent='No patterns loaded.'; return; }
     // Init Study State
     isIntroPhase = true; introStep = 0;
     studySlotIndex = 0; studySlotRepeat = 0; studyStepInSlot = 0;
  } else {
     const activeCount = makerSelectedObjs.filter(o=>o).length;
     if(activeCount===0){ statusEl.textContent='Pick at least 1 tile.'; return; }
     // Init Maker State
     makerCurrentStep = 0;
  }
  
  const ctx = ensureCtx(); ctx.resume();
  isPlaying = true;
  nextNoteTime = ctx.currentTime + 0.05;
  timer = setInterval(schedule, 25);
  statusEl.textContent = '';
}

function stop(){
  if(timer) clearInterval(timer); timer = null;
  isPlaying = false;
  clearSlotHighlights();
  
  // Reset ephemeral states
  if(APP_MODE === 'study'){
    isIntroPhase = false; introStep = 0;
    studySlotIndex = 0; studySlotRepeat = 0; studyStepInSlot = 0;
  } else {
    makerCurrentStep = 0;
  }
}

/* ==== App Mode Switching (Study vs Maker) ==== */
function switchAppMode(mode){
  if(isPlaying) stop();
  APP_MODE = mode;
  
  // UI Toggle
  if(mode === 'study'){
    btnModeStudy.classList.add('active');
    btnModeMaker.classList.remove('active');
    viewStudy.classList.remove('hidden');
    viewMaker.classList.add('hidden');
    titleEl.textContent = "4 8 16 Beat Exercise";
    clearBtn.classList.add('hidden'); // Hide Clear in Study
    
    // Ensure study patterns are loaded for current beat
    updateStudyPatterns(); 
  } else {
    btnModeMaker.classList.add('active');
    btnModeStudy.classList.remove('active');
    viewMaker.classList.remove('hidden');
    viewStudy.classList.add('hidden');
    titleEl.textContent = "Nick Drum Beat Maker";
    clearBtn.classList.remove('hidden'); // Show Clear in Maker
    
    renderMakerLibrary();
    renderMakerSelection();
  }
  statusEl.textContent = '';
  
  // *** 중요: 모드 전환 후 컨텐츠 높이가 달라지므로 스케일 다시 계산 ***
  setTimeout(applyVerticalFit, 0);
}

/* ==== Beat Mode Switching (4, 8, 16) ==== */
function setBeatMode(m){
  if(isPlaying) stop();
  BEAT_MODE = m;
  CONF = MODES[BEAT_MODE];
  PATTERNS = CONF.patterns.slice();
  
  // Update Tabs
  document.querySelectorAll('.tab').forEach(t => 
    t.classList.toggle('active', t.dataset.mode === BEAT_MODE)
  );
  
  // Update Note Text
  studyNoteEl.textContent = CONF.note;
  makerNoteEl.textContent = CONF.note;

  if(APP_MODE === 'study'){
    updateStudyPatterns();
  } else {
    // In maker mode, refresh library. Keep selected slots (user might want to clear manually)
    // But technically if we switch 4->16, the "id" logic holds, but the content changes.
    renderMakerLibrary();
    // Optional: could clear maker slots, but original code preserved state conceptually
    // Let's re-fetch the objects to ensure TILE_STEPS match new mode
    for(let i=0; i<4; i++){
      if(makerSelectedObjs[i]){
         makerSelectedObjs[i] = currentPatternObjectById(makerSelectedObjs[i].id);
      }
    }
    renderMakerSelection();
  }
}

function updateStudyPatterns(){
  // Auto-fill logic from index.html
  for (let i = 0; i < 9; i++){
    studySelectedObjs[i] = currentPatternObjectById(i) || null;
  }
  renderStudySelection();
}


/* ==== Device & Layout Helpers ==== */
function isPhoneLike(){
  const mq = window.matchMedia('(hover: none) and (pointer: coarse) and (max-width: 600px)');
  if (mq && typeof mq.matches === 'boolean') return mq.matches;
  const ua = navigator.userAgent.toLowerCase();
  const maybeMobile = /android|iphone|ipod|mobile|samsungbrowser/.test(ua);
  return maybeMobile && window.innerWidth <= 600;
}

function applyVerticalFit(){
  const wrap = document.getElementById('scaleWrap');
  const stage = document.getElementById('stage');
  if(!wrap || !stage) return;

  if (isPhoneLike()){
    wrap.style.transform = 'none';
    wrap.style.width = '100%';
    return;
  }

  wrap.style.transform = 'scale(1)';
  wrap.style.width = 'auto';

  const contentH = wrap.scrollHeight;
  const contentW = wrap.scrollWidth;
  const viewH = stage.clientHeight;
  const viewW = stage.clientWidth;
  if(contentH <= 0 || contentW <= 0) return;

  let scaleH = viewH / contentH;
  let scale  = scaleH;
  if (contentW * scaleH > viewW) {
    const scaleW = viewW / contentW;
    scale = Math.min(scaleH, scaleW);
  }
  wrap.style.transform = `scale(${scale})`;
  wrap.style.width = `calc(100% / ${scale})`;
}

/* ==== Fullscreen ==== */
const fsBtn = document.getElementById('fsBtn');
const fsEnterIcon = fsBtn ? fsBtn.querySelector('.icon.enter') : null;
const fsExitIcon  = fsBtn ? fsBtn.querySelector('.icon.exit')  : null;
const isFullscreenNow = () => document.fullscreenElement || document.webkitFullscreenElement;

function updateOrientationClasses(){
  const portrait = window.matchMedia('(orientation: portrait)').matches;
  document.body.classList.toggle('portrait', portrait);
  document.body.classList.toggle('landscape', !portrait);
  document.body.classList.toggle('fs-on', !!isFullscreenNow());
  applyVerticalFit();
}
async function fsToggle(){
  try{
    if (isFullscreenNow()){
      if (document.exitFullscreen) await document.exitFullscreen();
      else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
    } else {
      const el = document.documentElement;
      if (el.requestFullscreen) await el.requestFullscreen();
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    }
  } catch (err){ console.error(err); }
  finally { fsUpdateUI(); updateOrientationClasses(); }
}
function fsUpdateUI(){
  const on = !!isFullscreenNow();
  if (fsBtn) fsBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
  if (fsEnterIcon) fsEnterIcon.style.display = on ? 'none' : 'inline';
  if (fsExitIcon)  fsExitIcon.style.display  = on ? 'inline' : 'none';
}
if (fsBtn) fsBtn.addEventListener('click', fsToggle);
document.addEventListener('fullscreenchange', fsUpdateUI);
document.addEventListener('webkitfullscreenchange', fsUpdateUI);
window.addEventListener('orientationchange', updateOrientationClasses);
window.addEventListener('resize', updateOrientationClasses);

/* ==== Event Listeners ==== */
btnModeStudy.addEventListener('click', () => switchAppMode('study'));
btnModeMaker.addEventListener('click', () => switchAppMode('maker'));

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>setBeatMode(t.dataset.mode)));
document.getElementById('startBtn').addEventListener('click', start);
document.getElementById('stopBtn').addEventListener('click', stop);
clearBtn.addEventListener('click', ()=>{ 
  makerSelectedObjs=[null,null,null,null]; 
  renderMakerSelection(); 
  stop(); 
});

bpm.addEventListener('input', ()=>{ bpmVal.textContent=bpm.value; });
document.querySelectorAll('button[data-step]').forEach(btn=>btn.addEventListener('click',()=>{
  let v=parseInt(bpm.value,10)+parseInt(btn.dataset.step,10); 
  v=Math.max(60, Math.min(200,v)); bpm.value=v; bpmVal.textContent=v;
}));

document.addEventListener('keydown',(e)=>{
  const tag=(document.activeElement&&document.activeElement.tagName)||'';
  const typing = ['INPUT','TEXTAREA','SELECT'].includes(tag) || (document.activeElement && document.activeElement.isContentEditable);
  if(typing) return;
  const fsOn = !!isFullscreenNow();

  if(e.code==='Space'){ e.preventDefault(); isPlaying?stop():start(); }
  else if(e.code==='Escape'){
    e.preventDefault();
    if (fsOn){ fsToggle(); return; }
    stop();
    if(APP_MODE==='maker'){ makerSelectedObjs=[null,null,null,null]; renderMakerSelection(); }
    // Study mode usually doesn't clear on Esc in original, just stops? Original cleared.
    // Replicating original behavior:
    if(APP_MODE==='study'){
      studySelectedObjs=[null,null,null,null,null,null,null,null,null];
      renderStudySelection();
    }
  }
  else if(e.code==='Backspace'){ 
    if(APP_MODE === 'maker'){
      e.preventDefault(); 
      for(let i=3;i>=0;i--){ if(makerSelectedObjs[i]){ makerSelectedObjs[i]=null; break; } } 
      renderMakerSelection(); 
    }
  }
  else if(e.code==='ArrowLeft'){ let v=Math.max(60, parseInt(bpm.value,10)-5); bpm.value=v; bpmVal.textContent=v; }
  else if(e.code==='ArrowRight'){ let v=Math.min(200, parseInt(bpm.value,10)+5); bpm.value=v; bpmVal.textContent=v; }
  else if(e.key==='f' || e.key==='F' || e.code==='KeyF'){ e.preventDefault(); fsToggle(); }
});

/* ==== Init ==== */
// Initial Mode Setup
setBeatMode("4"); // This sets CONF and PATTERNS
switchAppMode("study"); // Starts in Study mode

window.addEventListener('load', applyVerticalFit);
window.addEventListener('resize', applyVerticalFit);
fsUpdateUI();
updateOrientationClasses();

</script>
</body>
</html>
