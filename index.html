<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>4 8 16 Beat Exercise (Large Title)</title>
<style>
  :root{
    --bg-grad: linear-gradient(135deg, #bfeee3 0%, #ffd8ba 50%, #bcd9f5 100%);
    --card: rgba(255,255,255,0.65);
    --section: rgba(245,248,250,.85);
    --text: #1c2c38;
    --sub: #385858;

    --radius: clamp(12px, 1.6vw, 16px);
    --gap: clamp(12px, 2.2vw, 20px);

    /* 타이틀 폰트 사이즈 1.5배 확대 (기존 32px -> 48px 시작) */
    --fs-title: clamp(48px, 8vw, 96px);

    --line: rgba(100,150,200,0.22);
    --line-strong: rgba(100,150,200,0.35);
    --hover: rgba(200,230,250,0.15);
    --chip-bg: rgba(200,230,250,.32);
  }

  *{ box-sizing: border-box; }
  html, body { height: 100%; min-height: 100dvh; }
  body{
    margin:0;
    color:var(--text);
    background: var(--bg-grad) fixed;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    overflow:hidden;
  }

  #stage{
    width: 100vw;
    height: 100vh;
    height: 100dvh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    overflow: hidden;
  }

  #scaleWrap { transform-origin: top center; }

  /* --- Header (기본: 세로 모드) --- */
  header{
    padding: clamp(24px, 5vw, 48px) 20px clamp(16px, 3vw, 24px);
    text-align:center; position:relative; overflow:hidden; isolation:isolate;
  }
  h1.title{
    margin:0;
    font-size: var(--fs-title);
    font-weight: 800;
    background: linear-gradient(90deg, #ffffff, #cfeae1);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    -webkit-text-fill-color:transparent; -webkit-text-stroke:1px black;
    line-height: 1.1;
    
    /* 세로 모드에서 1줄 강제 및 글자 간격 조정 */
    white-space: nowrap; 
    letter-spacing: -1px; 
  }

  main{ 
    max-width: min(1400px, 96vw); 
    margin: 0 auto clamp(36px,6vw,56px); 
    padding: 0 clamp(8px,2vw,16px); 
  }

  /* --- Layout Split (가로 모드 대응) --- */
  .layout-split {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }

  /* 4:3 비율 이상 (가로 모드) */
  @media (min-aspect-ratio: 4/3) {
    .layout-split {
      display: grid;
      grid-template-columns: 300px 1fr;
      align-items: stretch;
      gap: clamp(30px, 4vw, 50px);
      margin-top: 4vh;
    }
    
    .panel-left {
      display: flex;
      flex-direction: column;
    }
    
    /* 가로 모드에서는 타이틀 크기와 줄바꿈 방식 재정의 */
    header {
      padding: 0 0 24px 0;
      text-align: left;
    }
    h1.title {
      font-size: 42px; /* 사이드바에 맞는 적절한 크기로 고정 */
      white-space: normal; /* 가로 모드 사이드바에서는 필요시 줄바꿈 허용 */
      line-height: 1.1;
    }

    .panel-right {
      padding-top: 8px;
      display: flex;
      flex-direction: column;
    }

    .panel-left .controlsWrap {
      flex-direction: column;
      align-items: stretch;
      gap: 24px;
    }
    
    .panel-left #bpmStepGroup {
      display: grid !important;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-left: 0 !important;
      width: 100%;
    }
  }

  .card{
    background: var(--card);
    backdrop-filter: blur(8px);
    border: 0;
    border-radius: var(--radius);
    box-shadow: 0 12px 28px rgba(100,150,200,.22);
    padding: clamp(18px, 2.8vw, 32px);
  }

  .row{ display:flex; gap: clamp(8px,1.4vw,12px); align-items:center; flex-wrap: wrap; }
  .controlsWrap{ gap: var(--gap); justify-content: space-between; }
  
  .chip{ display:inline-block; font-size: 12px; color: var(--sub); padding: 2px 8px; border-radius: 999px; background: var(--chip-bg); border:1px solid rgba(100,150,200,.18); }

  /* Buttons */
  .btn{
    min-height: clamp(38px, 5.2vw, 48px);
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    border-radius: clamp(10px, 1.5vw, 12px);
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.55);
    color: var(--text);
    padding: 10px 16px;
    font-weight: 700;
    cursor:pointer;
    transition: transform .15s ease, box-shadow .2s ease, background .25s ease, border-color .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(100,150,200,0.15); background: var(--hover); border-color: var(--line-strong); }

  .modeToggle{
    display:flex;
    align-items:center;
    gap:8px;
    margin-right:16px;
  }
  .mode-btn{
    min-height: 48px;
    padding: 9px 18px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.55);
    font-size: 20px;
    font-weight: 600;
    color: var(--sub);
    cursor:pointer;
    transition: all .2s ease;
    display: flex; align-items: center; justify-content: center;
  }
  .mode-btn:hover{
    background: var(--hover);
    border-color: var(--line-strong);
    box-shadow: 0 3px 8px rgba(100,150,200,0.18);
    transform: translateY(-1px);
  }
  .mode-btn.active{
    background: rgba(255,255,255,0.9);
    box-shadow: 0 0 0 2px rgba(100,150,200,0.25) inset;
    border-color: var(--line-strong);
  }

  /* 가로 모드에서 버튼 스타일 조정 */
  @media (min-aspect-ratio: 4/3) {
    .panel-left #transportRow {
      flex-direction: column;
      align-items: stretch;
    }
    .panel-left .modeToggle {
      margin-right: 0;
      width: 100%;
    }
    .panel-left .mode-btn { flex: 1; }
    .panel-left #startBtn, .panel-left #stopBtn { width: 100%; }
    
    .panel-left #bpmRow { flex-direction: column; align-items: stretch; }
    .panel-left input[type=range] { width: 100%; }
  }

  input[type=range]{ width: 220px; accent-color: #6aa9e9; }
  .value{ width:56px; text-align:right; font-feature-settings:'tnum'; font-variant-numeric:tabular-nums; color: var(--sub); }
  .warn{ color:#a15c00; font-size: 12px; margin-left: 6px; }

  /* Slots */
  .selection{ display:flex; flex-direction:column; gap: var(--gap); }
  .selection-row{ display:grid; gap: var(--gap); }
  .selection-row.row-1{ grid-template-columns: repeat(4, 1fr); }
  
  @media (min-aspect-ratio: 4/3) {
    .selection-row.row-1 { grid-template-columns: 1fr 3fr; }
  }
  
  .selection-row.row-2, .selection-row.row-3{ grid-template-columns: repeat(4, 1fr); }
  
  .slot{
    aspect-ratio: 16 / 10;
    border:1px solid var(--line);
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center; padding:6px;
    background: rgba(255,255,255,.55);
    transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
    overflow: hidden;
  }
  .repeat{ font-size: 14px; font-weight: 600; color: var(--sub); opacity: .75; display: flex; align-items: center; }
  
  .slot.filled{ border-color: var(--line-strong); }
  .slot img{ width:100%; height:100%; object-fit: contain; border-radius: 8px; background:#fff; border:1px solid rgba(100,150,200,.26); }
  .slot.playing{ border-color: #6aa9e9 !important; box-shadow: 0 0 0 2px #6aa9e9 inset, 0 0 16px rgba(106,169,233,0.45); }

  /* Tabs */
  .tabs{ display:flex; gap: var(--gap); margin-bottom: clamp(12px,1.8vw,16px); }
  .tab{
    flex:1; text-align:center; cursor:pointer;
    padding: 12px; border-radius: 12px;
    background: rgba(255,255,255,.45);
    color: var(--text);
    border: 1px solid var(--line);
    transition: background .2s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .tab:hover{ background: var(--hover); border-color: var(--line-strong); }
  .tab.active{ background: rgba(255,255,255,.65); box-shadow: 0 0 0 2px rgba(100,150,200,.22) inset; }

  .note{ font-size: 12px; color: var(--sub); margin-top: 8px; }

  /* Mobile / Portrait Overrides */
  @media (hover: none) and (pointer: coarse) and (max-width: 600px){
    body{ overflow:auto; }
    #stage{ align-items: flex-start; }
    #scaleWrap{ transform: none !important; width: 100% !important; }
    .selection-row{ grid-template-columns: 1fr; }
    .selection-row.row-1 { grid-template-columns: 1fr !important; }
    header{ padding-top: 28px; }
    .layout-split { display: flex; flex-direction: column; margin-top: 0; }
    .panel-left .controlsWrap { flex-direction: row; }
    .panel-left #bpmStepGroup { display: flex !important; }
  }
 
  body.fs-on.portrait{
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }
  @media (orientation: portrait){
    #stage{ align-items: flex-start; }
    #scaleWrap img{ max-width: 100%; height: auto; object-fit: contain; }
    .layout-split { display: flex; flex-direction: column; grid-template-columns: none; margin-top: 0; }
    header { text-align: center; padding-bottom: clamp(16px, 3vw, 24px); }
    .panel-left .controlsWrap { flex-direction: row; align-items: center; }
    .panel-left #transportRow { flex-direction: row; }
    .panel-left #bpmRow { flex-direction: row; }
    .panel-left #bpmStepGroup { display: flex !important; margin-left: 10px !important; }
    h1.title { font-size: var(--fs-title); white-space: nowrap; }
    .panel-right { padding-top: 0; }
  }

/* Fullscreen button */
.fs-btn {
  position: fixed; top: 14px; right: 14px;
  display: inline-grid; place-items: center;
  width: 44px; height: 44px;
  border: none; border-radius: 9999px;
  background: rgba(0,0,0,0.6); color: #fff;
  cursor: pointer; transition: all 120ms ease;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25); z-index: 1000;
}
.fs-btn:hover { background: rgba(0,0,0,0.75); transform: translateY(-1px); }
.icon { width: 22px; height: 22px; display: inline; }
.icon.exit { display: none; }
</style>
</head>
<body>
<div id="stage">
  <div id="scaleWrap">
    
    <main>
      <div class="layout-split">
        
        <div class="panel-left">
          <header>
            <h1 class="title">4 8 16 Beat Exercise</h1>
          </header>

          <div class="card controls">
            <div class="row controlsWrap">
              
              <div class="row" id="transportRow" style="width:100%">
                <div class="modeToggle">
                  <button type="button" class="mode-btn active" data-mode="study">Study</button>
                  <button type="button" class="mode-btn" data-mode="maker">Maker</button>
                </div>
                <div style="display:flex; gap:8px; width:100%">
                   <button id="startBtn" class="btn" style="flex:1">Start</button>
                   <button id="stopBtn" class="btn" style="flex:1">Stop</button>
                </div>
              </div>

              <div class="row" id="bpmRow" style="width:100%">
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                  <span class="chip">BPM</span>
                  <div id="bpmVal" class="value">60</div>
                </div>
                <input id="bpm" type="range" min="60" max="200" value="60" style="width:100%" />
                
                <div class="row" id="bpmStepGroup" style="gap:6px;margin-left:0;width:100%;">
                  <button type="button" class="btn clear" data-step="-5" style="flex:1">-5</button>
                  <button type="button" class="btn clear" data-step="5" style="flex:1">+5</button>
                  <button type="button" class="btn clear" data-step="-1" style="flex:1">-1</button>
                  <button type="button" class="btn clear" data-step="1" style="flex:1">+1</button>
                </div>
                <div id="status" class="warn"></div>
              </div>

            </div>
          </div>
        </div>

        <div class="panel-right">
          <div class="tabs">
            <div class="tab active" data-mode="4">4 Beat</div>
            <div class="tab" data-mode="8">8 Beat</div>
            <div class="tab" data-mode="16">16 Beat</div>
          </div>

          <div class="card" style="margin-bottom: var(--gap);">
            <div class="selection" id="selection">
              <div class="selection-row row-1">
                <div class="slot" id="slot0"><span class="chip">Slot 1</span></div>
                <div class="repeat">2 times each</div>
              </div>
              <div class="selection-row row-2">
                <div class="slot" id="slot1"><span class="chip">Slot 2</span></div>
                <div class="slot" id="slot2"><span class="chip">Slot 3</span></div>
                <div class="slot" id="slot3"><span class="chip">Slot 4</span></div>
                <div class="slot" id="slot4"><span class="chip">Slot 5</span></div>
              </div>
              <div class="selection-row row-3">
                <div class="slot" id="slot5"><span class="chip">Slot 6</span></div>
                <div class="slot" id="slot6"><span class="chip">Slot 7</span></div>
                <div class="slot" id="slot7"><span class="chip">Slot 8</span></div>
                <div class="slot" id="slot8"><span class="chip">Slot 9</span></div>
              </div>
            </div>
            <div class="note" id="note"></div>
          </div>
        </div>

      </div> </main>

 </div>
</div>

<button id="fsBtn" class="fs-btn" aria-label="전체화면 전환 (F)" title="전체화면 전환 (F)" aria-pressed="false">
  <svg class="icon enter" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M4 10V4h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 14v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M4 4l7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <path d="M20 20l-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <svg class="icon exit" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M10 4H4v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M14 20h6v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M11 11L4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <path d="M13 13l7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>

<script>
/* ==== Patterns ==== */
const P4 = [
  { id:0, name:"Pattern 1", img:"Images/4beat/1.png", hh:[0,2], sd:[2], bd:[] },
  { id:1, name:"Pattern 2", img:"Images/4beat/2.png", hh:[0,2], sd:[2], bd:[0] },
  { id:2, name:"Pattern 3", img:"Images/4beat/3.png", hh:[0,2], sd:[2], bd:[1] },
  { id:3, name:"Pattern 4", img:"Images/4beat/4.png", hh:[0,2], sd:[2], bd:[2] },
  { id:4, name:"Pattern 5", img:"Images/4beat/5.png", hh:[0,2], sd:[2], bd:[3] },
  { id:5, name:"Pattern 6", img:"Images/4beat/6.png", hh:[0,2], sd:[2], bd:[0, 1] },
  { id:6, name:"Pattern 7", img:"Images/4beat/7.png", hh:[0,2], sd:[2], bd:[0, 3] },
  { id:7, name:"Pattern 8", img:"Images/4beat/8.png", hh:[0,2], sd:[2], bd:[0, 2] },
  { id:8, name:"Pattern 9", img:"Images/4beat/9.png", hh:[0,2], sd:[2], bd:[1, 3] }
];
const P8 = [
  { id:0, name:"Pattern 1", img:'Images/8beat/1.png', hh:[0,1,2,3], sd:[2], bd:[] },
  { id:1, name:"Pattern 2", img:'Images/8beat/2.png', hh:[0,1,2,3], sd:[2], bd:[0] },
  { id:2, name:"Pattern 3", img:'Images/8beat/3.png', hh:[0,1,2,3], sd:[2], bd:[1] },
  { id:3, name:"Pattern 4", img:'Images/8beat/4.png', hh:[0,1,2,3], sd:[2], bd:[2] },
  { id:4, name:"Pattern 5", img:'Images/8beat/5.png', hh:[0,1,2,3], sd:[2], bd:[3] },
  { id:5, name:"Pattern 6", img:'Images/8beat/6.png', hh:[0,1,2,3], sd:[2], bd:[0, 1] },
  { id:6, name:"Pattern 7", img:'Images/8beat/7.png', hh:[0,1,2,3], sd:[2], bd:[0, 3] },
  { id:7, name:"Pattern 8", img:'Images/8beat/8.png', hh:[0,1,2,3], sd:[2], bd:[0, 2] },
  { id:8, name:"Pattern 9", img:'Images/8beat/9.png', hh:[0,1,2,3], sd:[2], bd:[1, 3] }
];
const P16 = [
  { id:0, name:'Pattern 1', img:'Images/16beat/1.png', hh:[0,1,2,3,4,5,6,7], bd:[], sd:[4] },
  { id:1, name:'Pattern 2', img:'Images/16beat/2.png', hh:[0,1,2,3,4,5,6,7], bd:[0], sd:[4] },
  { id:2, name:'Pattern 3', img:'Images/16beat/3.png', hh:[0,1,2,3,4,5,6,7], bd:[2], sd:[4] },
  { id:3, name:'Pattern 4', img:'Images/16beat/4.png', hh:[0,1,2,3,4,5,6,7], bd:[4], sd:[4] },
  { id:4, name:'Pattern 5', img:'Images/16beat/5.png', hh:[0,1,2,3,4,5,6,7], bd:[6], sd:[4] },
  { id:5, name:'Pattern 6', img:'Images/16beat/6.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 2], sd:[4] },
  { id:6, name:'Pattern 7', img:'Images/16beat/7.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 6], sd:[4] },
  { id:7, name:'Pattern 8', img:'Images/16beat/8.png', hh:[0,1,2,3,4,5,6,7], bd:[0, 4], sd:[4] },
  { id:8, name:'Pattern 9', img:'Images/16beat/9.png', hh:[0,1,2,3,4,5,6,7], bd:[2, 6], sd:[4] }
];

const MODES = {
  "4":  { title:"4 Beat",  patterns:P4,  tileSteps:4,  stepType:"eighth",    note:"" },
  "8":  { title:"8 Beat",  patterns:P8,  tileSteps:4,  stepType:"eighth",    note:"" },
  "16": { title:"16 Beat", patterns:P16, tileSteps:8,  stepType:"sixteenth", note:"" }
};

function toSixteenthPattern(p, stepType, tileSteps){
  const mul = (stepType==='eighth') ? 2 : 1;
  const map = arr => (arr||[]).map(v => v*mul);
  return { id:p.id, name:p.name, img:p.img, hh:map(p.hh), sd:map(p.sd), bd:map(p.bd), TILE_STEPS: tileSteps * mul };
}
function currentPatternObjectById(id){
  const conf = MODES[MODE];
  const src = conf.patterns.find(x=>x.id===id);
  if(!src) return null;
  return toSixteenthPattern(src, conf.stepType, conf.tileSteps);
}

/* === State === */
let MODE="4";
let CONF=MODES[MODE];
let PATTERNS=CONF.patterns.slice();
let selectedObjs=[null,null,null,null,null,null,null,null,null];
let isPlaying=false, nextNoteTime=0, currentStep=0, timer=null;
let isIntroPhase=false, introStep=0;
let slotOrder=[], slotIndex=0, slotRepeat=0, stepInSlot=0;

const noteEl=document.getElementById('note');
const slots=[
  document.getElementById('slot0'),
  document.getElementById('slot1'),
  document.getElementById('slot2'),
  document.getElementById('slot3'),
  document.getElementById('slot4'),
  document.getElementById('slot5'),
  document.getElementById('slot6'),
  document.getElementById('slot7'),
  document.getElementById('slot8')
];
const statusEl=document.getElementById('status');
const bpm=document.getElementById('bpm'), bpmVal=document.getElementById('bpmVal');

/* === Audio === */
let audioCtx, masterGain, reverb;
function ensureCtx(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(audioCtx.destination);
    reverb = audioCtx.createConvolver(); reverb.buffer = createReverbIR(audioCtx, 1.5, 2.5); reverb.connect(masterGain);
  }
  return audioCtx;
}
function createReverbIR(ctx, seconds=1.5, decay=2.5){
  const rate=ctx.sampleRate, length=Math.floor(rate*seconds);
  const buf=ctx.createBuffer(2,length,rate);
  for(let ch=0;ch<2;ch++){
    const d=buf.getChannelData(ch);
    for(let i=0;i<length;i++){ const t=i/length; d[i]=(Math.random()*2-1)*Math.pow(1-t,decay); }
  }
  return buf;
}
function playKick(time){
  const ctx=ensureCtx();
  const osc=ctx.createOscillator(); osc.type='sine';
  osc.frequency.setValueAtTime(150,time); osc.frequency.exponentialRampToValueAtTime(50,time+0.12);
  const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.14);
  osc.connect(g); g.connect(masterGain); g.connect(reverb);
  osc.start(time); osc.stop(time+0.16);
}
function playSnare(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.25, ctx.sampleRate);
  const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb;
  const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.7;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=900;
  const g=ctx.createGain(); g.gain.setValueAtTime(1.0,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.18);
  src.connect(bp).connect(hp).connect(g); g.connect(masterGain); g.connect(reverb);
  src.start(time); src.stop(time+0.22);
}
function playHat(time){
  const ctx=ensureCtx();
  const nb=ctx.createBuffer(1, ctx.sampleRate*0.08, ctx.sampleRate);
  const d=nb.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
  const src=ctx.createBufferSource(); src.buffer=nb;
  const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=8000;
  const g=ctx.createGain(); g.gain.setValueAtTime(0.6,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  src.connect(hp).connect(g); g.connect(masterGain); g.connect(reverb);
  src.start(time); src.stop(time+0.08);
}

/* === Timing === */
function stepDurationSec(){
  const v=parseInt(bpm.value,10);
  return 60/(v*4);
}

/* === Slot highlight === */
function updateSlotHighlight(activeIdx){
  for(let i=0;i<slots.length;i++){
    const el=slots[i]; if(!el) continue;
    if(i===activeIdx) el.classList.add('playing'); else el.classList.remove('playing');
  }
}
function clearSlotHighlight(){ slots.forEach(el=>el.classList.remove('playing')); }

/* === Scheduler === */
function schedule(){
  const ctx = ensureCtx();
  const stepDur = stepDurationSec();
  const INTRO_STEPS = 16;
  const INTRO_CLICK_INTERVAL = 4;

  while(nextNoteTime < ctx.currentTime + 0.12){
    const t = nextNoteTime;

    // 1) 예비박(4카운트)
    if(isIntroPhase){
      if(introStep % INTRO_CLICK_INTERVAL === 0){
        playHat(t);
      }
      introStep++;
      nextNoteTime += stepDur;
      if(introStep >= INTRO_STEPS){
        isIntroPhase = false;
        clearSlotHighlight();
        slotIndex = 0;
        slotRepeat = 0;
        stepInSlot = 0;
      }
      continue;
    }

    // 2) 본 패턴
    if(!slotOrder || slotOrder.length === 0){
      stop();
      break;
    }

    if(slotIndex >= slotOrder.length){
      const curBpm = parseInt(bpm.value, 10);
      if(curBpm < 200){
        const newBpm = Math.min(200, curBpm + 10);
        bpm.value = newBpm;
        bpmVal.textContent = newBpm;
      }
      isIntroPhase = true;
      introStep = 0;
      slotIndex = 0;
      slotRepeat = 0;
      stepInSlot = 0;
      clearSlotHighlight();
      continue;
    }

    const idx = slotOrder[slotIndex];
    const tile = selectedObjs[idx];
    if(!tile){
      slotIndex++;
      slotRepeat = 0;
      stepInSlot = 0;
      continue;
    }
    const stepsInTile = tile.TILE_STEPS || 0;
    if(stepsInTile <= 0){
      slotIndex++;
      slotRepeat = 0;
      stepInSlot = 0;
      continue;
    }

    updateSlotHighlight(idx);

    const s = stepInSlot;
    if(tile.hh && tile.hh.includes(s)) playHat(t);
    if(tile.sd && tile.sd.includes(s)) playSnare(t);
    if(tile.bd && tile.bd.includes(s)) playKick(t);

    stepInSlot++;
    nextNoteTime += stepDur;

    if(stepInSlot >= stepsInTile){
      stepInSlot = 0;
      slotRepeat++;
      if(slotRepeat >= 2){
        slotRepeat = 0;
        slotIndex++;
      }
    }
  }
}

/* === Transport === */
function start(){
  if(selectedObjs.every(o=>!o)){
    statusEl.textContent='Pick at least 1 tile.';
    return;
  }
  slotOrder = [];
  for(let i=0;i<selectedObjs.length;i++){
    if(selectedObjs[i]) slotOrder.push(i);
  }
  if(slotOrder.length === 0){
    statusEl.textContent='Pick at least 1 tile.';
    return;
  }

  const ctx = ensureCtx();
  ctx.resume();
  isPlaying = true;
  isIntroPhase = true;
  introStep = 0;
  slotIndex = 0;
  slotRepeat = 0;
  stepInSlot = 0;
  nextNoteTime = ctx.currentTime + 0.05;
  timer = setInterval(schedule,25);
  statusEl.textContent = '';
}
function stop(){
  if(timer) clearInterval(timer);
  timer = null;
  isPlaying = false;
  clearSlotHighlight();
  isIntroPhase = false;
  introStep = 0;
  slotOrder = [];
  slotIndex = 0;
  slotRepeat = 0;
  stepInSlot = 0;
}

/* === UI rendering === */
function renderSelection(){
  clearSlotHighlight();
  for(let i=0;i<slots.length;i++){
    const el=slots[i]; if(!el) continue;
    el.innerHTML='';
    const obj=selectedObjs[i];
    if(!obj){
      el.classList.remove('filled');
      el.innerHTML=`<span class="chip">Slot ${i+1}</span>`;
    } else {
      el.classList.add('filled');
      el.innerHTML=`<img src="${obj.img}" alt="Pattern ${obj.id}">`;
    }
  }
}

/* === Mode switching === */
function setMode(m){
  if(isPlaying) stop();
  MODE = m;
  CONF = MODES[MODE];
  PATTERNS = CONF.patterns.slice();

  selectedObjs = [];
  for (let i = 0; i < 9; i++){
    const obj = currentPatternObjectById(i);
    selectedObjs.push(obj || null);
  }

  document.querySelectorAll('.tab').forEach(t =>
    t.classList.toggle('active', t.dataset.mode === MODE)
  );
  document.getElementById('note').textContent = CONF.note;
  renderSelection();
}

/* === Device detection helpers === */
function isPhoneLike(){
  const mq = window.matchMedia('(hover: none) and (pointer: coarse) and (max-width: 600px)');
  if (mq && typeof mq.matches === 'boolean') return mq.matches;
  const ua = navigator.userAgent.toLowerCase();
  const maybeMobile = /android|iphone|ipod|mobile|samsungbrowser/.test(ua);
  return maybeMobile && window.innerWidth <= 600;
}

/* === Vertical-first fit === */
function applyVerticalFit(){
  const wrap = document.getElementById('scaleWrap');
  const stage = document.getElementById('stage');
  if(!wrap || !stage) return;

  if (isPhoneLike()){
    wrap.style.transform = 'none';
    wrap.style.width = '100%';
    return;
  }

  wrap.style.transform = 'scale(1)';
  wrap.style.width = 'auto';

  const contentH = wrap.scrollHeight;
  const contentW = wrap.scrollWidth;
  const viewH = stage.clientHeight;
  const viewW = stage.clientWidth;
  if(contentH <= 0 || contentW <= 0) return;

  let scaleH = viewH / contentH;
  let scale  = scaleH;
  if (contentW * scaleH > viewW) {
    const scaleW = viewW / contentW;
    scale = Math.min(scaleH, scaleW);
  }
  wrap.style.transform = `scale(${scale})`;
  wrap.style.width = `calc(100% / ${scale})`;
}

/* === Fullscreen helpers === */
const fsBtn = document.getElementById('fsBtn');
const fsEnterIcon = fsBtn ? fsBtn.querySelector('.icon.enter') : null;
const fsExitIcon  = fsBtn ? fsBtn.querySelector('.icon.exit')  : null;
const isFullscreenNow = () => document.fullscreenElement || document.webkitFullscreenElement;

function updateOrientationClasses(){
  const portrait = window.matchMedia('(orientation: portrait)').matches;
  document.body.classList.toggle('portrait', portrait);
  document.body.classList.toggle('landscape', !portrait);
  document.body.classList.toggle('fs-on', !!isFullscreenNow());
  applyVerticalFit();
}
function fsEnter(el){
  if (el.requestFullscreen) return el.requestFullscreen();
  if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
  return Promise.reject(new Error('Fullscreen API not supported'));
}
function fsExit(){
  if (document.exitFullscreen) return document.exitFullscreen();
  if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
  return Promise.reject(new Error('Fullscreen API not supported'));
}
function fsUpdateUI(){
  const on = !!isFullscreenNow();
  if (fsBtn) fsBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
  if (fsEnterIcon) fsEnterIcon.style.display = on ? 'none' : 'inline';
  if (fsExitIcon)  fsExitIcon.style.display  = on ? 'inline' : 'none';
  updateOrientationClasses();
}
async function fsToggle(){
  try{
    if (isFullscreenNow()){
      await fsExit();
      updateOrientationClasses();
    } else {
      await fsEnter(document.documentElement);
      updateOrientationClasses();
    }
  } catch (err){
    console.error(err);
  } finally {
    fsUpdateUI();
  }
}
if (fsBtn) fsBtn.addEventListener('click', fsToggle);
document.addEventListener('fullscreenchange', fsUpdateUI);
document.addEventListener('webkitfullscreenchange', fsUpdateUI);
window.addEventListener('orientationchange', updateOrientationClasses);
window.addEventListener('resize', updateOrientationClasses);

/* === Events === */
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.dataset.mode;
    if(target === 'maker'){
      window.location.href = 'Beat Maker.html';
    } else {
      document.querySelectorAll('.mode-btn').forEach(b =>
        b.classList.toggle('active', b === btn)
      );
    }
  });
});

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>setMode(t.dataset.mode)));
document.getElementById('startBtn').addEventListener('click', start);
document.getElementById('stopBtn').addEventListener('click', stop);

bpm.addEventListener('input', ()=>{ bpmVal.textContent=bpm.value; });
document.querySelectorAll('button[data-step]').forEach(btn=>btn.addEventListener('click',()=>{
  let v=parseInt(bpm.value,10)+parseInt(btn.dataset.step,10); v=Math.max(60, Math.min(200,v)); bpm.value=v; bpmVal.textContent=v;
}));

document.addEventListener('keydown',(e)=>{
  const tag=(document.activeElement&&document.activeElement.tagName)||'';
  const typing = ['INPUT','TEXTAREA','SELECT'].includes(tag) || (document.activeElement && document.activeElement.isContentEditable);
  if(typing) return;
  const fsOn = !!(document.fullscreenElement || document.webkitFullscreenElement);
  if(e.code==='Space'){ e.preventDefault(); isPlaying?stop():start(); }
  else if(e.code==='Escape'){
    e.preventDefault();
    if (fsOn){
      try{
        (document.exitFullscreen && document.exitFullscreen()) || (document.webkitExitFullscreen && document.webkitExitFullscreen());
      } catch(_){}
      updateOrientationClasses();
      return;
    }
    selectedObjs=[null,null,null,null,null,null,null,null,null];
    renderSelection();
    stop();
  }
  else if(e.code==='ArrowLeft'){ let v=Math.max(60, parseInt(bpm.value,10)-5); bpm.value=v; bpmVal.textContent=v; }
  else if(e.code==='ArrowRight'){ let v=Math.min(200, parseInt(bpm.value,10)+5); bpm.value=v; bpmVal.textContent=v; }
  else if(e.key==='f' || e.key==='F' || e.code==='KeyF'){ e.preventDefault(); fsToggle(); }
});

/* === Init === */
setMode("4");
window.addEventListener('load', applyVerticalFit);
window.addEventListener('resize', applyVerticalFit);
fsUpdateUI && fsUpdateUI();
updateOrientationClasses();
</script>
</body>
</html>
